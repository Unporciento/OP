<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Calculadora Científica + Eléctrica Pro</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; background: #071020; color: #dff6ff; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .container { max-width: 900px; margin: 8px auto; padding: 8px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 8px; }
    .tab { flex: 1; padding: 10px; border-radius: 10px; text-align: center; background: #0b1220; color: #cfe5ff; border: 1px solid rgba(255,255,255,0.03); cursor: pointer; font-weight: 600; }
    .tab.active { background: linear-gradient(90deg, #0ea5a6, #028489); color: #012; }
    .panel { display: none; background: #08101a; padding: 10px; border-radius: 12px; }
    .panel.active { display: block; }
    /* Calculadora */
    .calculator { border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .screen { background: linear-gradient(180deg, #0f1724, #071021); color: #e6eef8; padding: 14px; min-height: 100px; display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
    .expr { font-size: 18px; opacity: .85; word-break: break-all; }
    .result { font-size: 28px; font-weight: 700; margin-top: 6px; }
    .keys { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 12px; background: #07121a; }
    button { padding: 14px; border-radius: 10px; border: 0; font-size: 16px; touch-action: manipulation; cursor: pointer; }
    button:active { transform: translateY(1px); }
    .btn-fn { background: #111827; color: #cbd5e1; }
    .btn-op { background: #1f2937; color: #fff; }
    .btn-num { background: linear-gradient(180deg, #0ea5a6, #028489); color: #fff; }
    .btn-eq { grid-column: span 2; background: linear-gradient(180deg, #f97316, #ea580c); color: #fff; font-weight: 700; }
    /* Historial / memoria */
    .history { max-height: 140px; overflow-y: auto; padding: 6px; background: rgba(255,255,255,0.02); border-radius: 8px; font-size: 13px; }
    .result-box { background: rgba(255,255,255,0.02); padding: 8px; border-radius: 6px; margin-top: 8px; color: #dff6ff; white-space: pre-wrap; }
    /* Eléctrica módulo */
    .grid-elect { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .card { background: linear-gradient(180deg, #071428, #052033); padding: 12px; border-radius: 10px; }
    label { display: block; font-size: 13px; color: #9fb0c8; margin-bottom: 6px; }
    input, select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); color: #eaf6ff; }
    input:disabled, select:disabled { opacity: 0.6; background: rgba(255,255,255,0.01); }
    .btn-primary { background: linear-gradient(90deg, #0ea5a6, #028489); color: #fff; padding: 8px; border-radius: 8px; border: 0; cursor: pointer; }
    .btn-sec { background: #1f2937; color: #fff; padding: 8px; border-radius: 8px; border: 0; cursor: pointer; }
    /* Modal */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
    .modal .box { background: #09121a; padding: 16px; border-radius: 10px; max-width: 400px; width: 100%; color: #eaf6ff; }
    .close { float: right; cursor: pointer; padding: 6px; border-radius: 6px; background: rgba(255,255,255,0.02); font-weight: 700; }
    /* Graficador */
    canvas { width: 100%; height: 300px; background: #012; border-radius: 6px; border: 1px solid #0ea5a6; }
    /* Móvil responsive */
    @media (max-width: 600px) {
      .keys { grid-template-columns: repeat(4, 1fr); }
      .btn-eq { grid-column: span 2; }
      button { padding: 16px; font-size: 18px; }
      .screen { min-height: 120px; }
      .expr { font-size: 20px; }
      .result { font-size: 34px; }
      .history { max-height: 100px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <div id="tabCalc" class="tab active">Científica</div>
      <div id="tabElec" class="tab">Eléctrica</div>
      <div id="tabGraph" class="tab">Gráfica</div>
    </div>

    <!-- PANEL CIENTÍFICA -->
    <div id="panelCalc" class="panel active">
      <div class="calculator">
        <div class="screen">
          <div class="expr" id="expr">0</div>
          <div class="result" id="result"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:8px;background:#061220">
          <div style="display:flex;gap:8px;align-items:center">
            <button data-mem="mc" class="btn-fn">MC</button>
            <button data-mem="mr" class="btn-fn">MR</button>
            <button data-mem="mplus" class="btn-fn">M+</button>
            <button data-mem="mminus" class="btn-fn">M-</button>
          </div>
          <div style="margin-left:auto;color:#9fb0c8">
            <label style="display:inline-flex;align-items:center;gap:8px">
              <input type="checkbox" id="degToggle" /> <span id="degLabel">RADIANES</span>
            </label>
          </div>
        </div>
        <div style="padding:8px">
          <div class="keys" id="keys">
            <button class="btn-fn" data-action="pi">π</button>
            <button class="btn-fn" data-action="exp">e</button>
            <button class="btn-fn" data-action="fact">x!</button>
            <button class="btn-fn" data-value="^">x^y</button>
            <button class="btn-fn" data-action="sqrt">√</button>

            <button class="btn-fn" data-action="sin">sin</button>
            <button class="btn-fn" data-action="cos">cos</button>
            <button class="btn-fn" data-action="tan">tan</button>
            <button class="btn-fn" data-action="ln">ln</button>
            <button class="btn-fn" data-action="log">log</button>

            <button class="btn-fn" data-action="clear">AC</button>
            <button class="btn-fn" data-action="back">⌫</button>
            <button class="btn-fn" data-value="(">(</button>
            <button class="btn-fn" data-value=")">)</button>

            <button class="btn-num" data-value="7">7</button>
            <button class="btn-num" data-value="8">8</button>
            <button class="btn-num" data-value="9">9</button>
            <button class="btn-op" data-value="/">÷</button>

            <button class="btn-num" data-value="4">4</button>
            <button class="btn-num" data-value="5">5</button>
            <button class="btn-num" data-value="6">6</button>
            <button class="btn-op" data-value="*">×</button>

            <button class="btn-num" data-value="1">1</button>
            <button class="btn-num" data-value="2">2</button>
            <button class="btn-num" data-value="3">3</button>
            <button class="btn-op" data-value="-">−</button>

            <button class="btn-num" data-value="0">0</button>
            <button class="btn-num" data-value=".">.</button>
            <button class="btn-fn" data-value="%">%</button>
            <button class="btn-op" data-value="+">+</button>

            <button class="btn-fn" data-action="ans">ANS</button>
            <button class="btn-fn" data-action="toggleSign">+/-</button>
            <button class="btn-op btn-eq" id="equals">=</button>
            <button class="btn-fn" data-action="abs">abs</button>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <div class="small">Historial (científica) <button class="btn-sec" id="clearHistCalc" style="padding:2px 6px;margin-left:4px">Limpiar</button></div>
          <div id="histCalc" class="history"></div>
        </div>
        <div style="width:220px">
          <div class="small">Memoria</div>
          <div id="memBox" class="result-box">0</div>
        </div>
      </div>
    </div>

    <!-- PANEL ELÉCTRICA -->
    <div id="panelElec" class="panel">
      <div class="grid-elect">
        <div class="card">
          <h3>Ohm / Potencia</h3>
          <label class="small">Elige variable a calcular (Rellena al menos dos de las otras):</label>
          <select id="ohmTarget" style="margin-bottom:8px">
            <option value="none">Automático</option>
            <option value="V">Voltaje (V)</option>
            <option value="I">Corriente (A)</option>
            <option value="R">Resistencia (Ω)</option>
            <option value="P">Potencia (W)</option>
          </select>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>Voltaje V (V)</label><input id="ohmV" data-var="V" placeholder="ej: 12" inputmode="decimal" /></div>
            <div><label>Corriente I (A)</label><input id="ohmI" data-var="I" placeholder="ej: 0.5" inputmode="decimal" /></div>
            <div><label>Resistencia R (Ω)</label><input id="ohmR" data-var="R" placeholder="ej: 24" inputmode="decimal" /></div>
            <div><label>Potencia P (W)</label><input id="ohmP" data-var="P" placeholder="ej: 6" inputmode="decimal" /></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="calcOhm">Calcular</button>
            <button class="btn-sec" id="stepOhm">Ver pasos</button>
            <button class="btn-sec" id="clearOhm">Limpiar</button>
          </div>
          <div class="result-box" id="ohmResult">Resultados...</div>
        </div>

        <div class="card">
          <h3>Resistencias / Reactancia</h3>
          <label class="small">Resistencias R (Ω) — separa con comas:</label>
          <input id="resList" placeholder="ej: 100,220,330" inputmode="decimal" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="calcSeries">Serie</button>
            <button class="btn-primary" id="calcParallel">Paralelo</button>
            <button class="btn-sec" id="stepRes">Pasos</button>
          </div>
          <div class="result-box" id="resResult">—</div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:8px 0" />

          <label class="small">Frecuencia (Hz)</label><input id="freq" placeholder="ej: 50" inputmode="decimal" />
          <label class="small">Capacitancia (µF)</label><input id="cap" placeholder="ej: 10" inputmode="decimal" />
          <label class="small">Inductancia (mH)</label><input id="ind" placeholder="ej: 10" inputmode="decimal" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="calcReact">Calcular Xc / Xl</button>
            <button class="btn-sec" id="stepReact">Pasos</button>
          </div>
          <div class="result-box" id="reactResult">—</div>
        </div>

        <div class="card">
          <h3>Resistor para LED</h3>
          <label class="small">Voltaje fuente (Vs)</label><input id="ledV" placeholder="ej: 5" inputmode="decimal" />
          <label class="small">Voltaje LED (Vf)</label><input id="ledVf" placeholder="ej: 2" inputmode="decimal" />
          <label class="small">Corriente (I, mA)</label><input id="ledI" placeholder="ej: 20" inputmode="decimal" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="calcLed">Calcular</button>
            <button class="btn-sec" id="stepLed">Pasos</button>
          </div>
          <div class="result-box" id="ledResult">—</div>
        </div>

        <div class="card">
          <h3>Ley de Joule</h3>
          <label class="small">Corriente (I, A)</label><input id="jouleI" placeholder="ej: 2" inputmode="decimal" />
          <label class="small">Resistencia (Ω)</label><input id="jouleR" placeholder="ej: 4" inputmode="decimal" />
          <label class="small">Tiempo (s)</label><input id="jouleT" placeholder="ej: 10" inputmode="decimal" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="calcJoule">Calcular</button>
            <button class="btn-sec" id="stepJoule">Pasos</button>
          </div>
          <div class="result-box" id="jouleResult">—</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="small">Historial Eléctrico <button class="btn-sec" id="clearHistElec" style="padding:2px 6px;margin-left:4px">Limpiar</button></div>
        <div id="histElec" class="history"></div>
      </div>
    </div>

    <!-- PANEL GRÁFICA -->
    <div id="panelGraph" class="panel">
      <div class="card">
        <h3>Graficador 2D</h3>
        <label class="small">Función en x (ej: sin(x), x^2 - 2x):</label>
        <input id="funcExpr" placeholder="ej: sin(x)" />
        <div style="display:flex;gap:8px;margin-top:8px; flex-wrap: wrap;">
          <label style="margin-bottom:0">Rango X:</label>
          <input id="xMin" placeholder="-10" style="width:100px" inputmode="decimal" />
          <input id="xMax" placeholder="10" style="width:100px" inputmode="decimal" />
          <button class="btn-primary" id="plotBtn">Graficar</button>
          <button class="btn-sec" id="clearPlot">Limpiar</button>
        </div>
        <canvas id="plotCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Modal pasos -->
  <div id="modal" class="modal">
    <div class="box">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Pasos y explicaciones</h3>
        <div class="close" id="closeModal">✕</div>
      </div>
      <div id="modalContent" style="margin-top:10px;white-space:pre-wrap;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mathjs@12.4.1/lib/browser/math.min.js"></script>
  <script>
    // Variables globales
    const mjs = math.create(math.all, { number: 'number', precision: 14 });
    let expr = '';
    let lastAnswer = 0;
    let mem = Number(localStorage.getItem('calc_mem') || 0);
    let useDegrees = localStorage.getItem('calc_deg') === 'true';

    const histCalc = JSON.parse(localStorage.getItem('hist_calc') || '[]');
    const histElec = JSON.parse(localStorage.getItem('hist_elec') || '[]');

    // DOM
    const exprEl = document.getElementById('expr');
    const resultEl = document.getElementById('result');
    const keys = document.getElementById('keys');
    const degToggle = document.getElementById('degToggle');
    const degLabel = document.getElementById('degLabel');
    const memBox = document.getElementById('memBox');
    const ohmTarget = document.getElementById('ohmTarget');

    function toNum(v) {
      if (v === '' || v == null) return null;
      const n = Number(v.toString().replace(',', '.'));
      return isNaN(n) ? null : n;
    }
    function formatRes(r) {
      return mjs.format(r, { precision: 14, lowercase: true });
    }
    function refreshAll() {
      exprEl.textContent = expr || '0';
      degToggle.checked = useDegrees;
      degLabel.textContent = useDegrees ? 'GRADOS' : 'RADIANES';
      memBox.textContent = formatRes(mem);
      renderHistories();
    }
    function renderHistories() {
      document.getElementById('histCalc').innerHTML = histCalc.map(h => `<div>${h.in} = ${h.out}</div>`).join('');
      document.getElementById('histElec').innerHTML = histElec.map(h => `<div>${h}</div>`).join('');
    }
    function recordHist(list, entry) {
      list.unshift(entry);
      if (list.length > 100) list.pop();
      if (list === histCalc) localStorage.setItem('hist_calc', JSON.stringify(list));
      else localStorage.setItem('hist_elec', JSON.stringify(list));
    }

    degToggle.addEventListener('change', () => {
      useDegrees = degToggle.checked;
      localStorage.setItem('calc_deg', useDegrees);
      refreshAll();
    });

    // Tabs
    const tabCalc = document.getElementById('tabCalc');
    const tabElec = document.getElementById('tabElec');
    const tabGraph = document.getElementById('tabGraph');
    const panelCalc = document.getElementById('panelCalc');
    const panelElec = document.getElementById('panelElec');
    const panelGraph = document.getElementById('panelGraph');
    function showTab(name) {
      tabCalc.classList.remove('active');
      tabElec.classList.remove('active');
      tabGraph.classList.remove('active');
      panelCalc.classList.remove('active');
      panelElec.classList.remove('active');
      panelGraph.classList.remove('active');
      if (name === 'calc') { tabCalc.classList.add('active'); panelCalc.classList.add('active'); }
      if (name === 'elec') { tabElec.classList.add('active'); panelElec.classList.add('active'); }
      if (name === 'graph') { tabGraph.classList.add('active'); panelGraph.classList.add('active'); }
    }
    tabCalc.addEventListener('click', () => showTab('calc'));
    tabElec.addEventListener('click', () => showTab('elec'));
    tabGraph.addEventListener('click', () => showTab('graph'));

    // Calculadora lógica
    function toggleSign(s) {
      if (!s) return '-';
      const m = s.match(/(.*?)(-?[0-9\\.]+)$/);
      if (m) {
        const base = m[1], num = m[2];
        return base + '(' + (-Number(num)) + ')';
      }
      return s;
    }
    function handleAction(action) {
      switch (action) {
        case 'clear': expr = ''; resultEl.textContent = ''; break;
        case 'back': expr = expr.slice(0, -1); break;
        case 'ans': expr += 'ans'; break;
        case 'pi': expr += 'pi'; break;
        case 'exp': expr += 'e'; break;
        case 'fact': expr += 'factorial('; break;
        case 'sqrt': expr += 'sqrt('; break;
        case 'abs': expr += 'abs('; break;
        case 'sin': case 'cos': case 'tan': expr += action + '('; break;
        case 'ln': expr += 'ln('; break;
        case 'log': expr += 'log('; break;
        case 'toggleSign': expr = toggleSign(expr); break;
      }
    }
    keys.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const v = btn.dataset.value;
      const action = btn.dataset.action;
      const memAct = btn.dataset.mem;
      if (v != null) { expr += v; refreshAll(); return; }
      if (action) { handleAction(action); refreshAll(); }
      if (memAct) { handleMemory(memAct); }
    });
    document.getElementById('equals').addEventListener('click', () => {
      if (!expr) return;
      let s = expr.replace(/%/g, '/100').replace(/÷/g, '/').replace(/×/g, '*').replace(/−/g, '-');
      s = s.replace(/ans/g, `(${String(lastAnswer)})`);
      try {
        const res = mjs.evaluate(s);
        lastAnswer = typeof res === 'number' ? res : Number(res);
        const out = formatRes(res);
        resultEl.textContent = out;
        recordHist(histCalc, { in: expr, out });
        expr = '';
        refreshAll();
      } catch (err) {
        resultEl.textContent = 'Error';
        expr = '';
        refreshAll();
      }
    });
    document.getElementById('clearHistCalc').addEventListener('click', () => {
      histCalc.length = 0;
      localStorage.setItem('hist_calc', '[]');
      renderHistories();
    });

    function handleMemory(act) {
      const value = lastAnswer || 0;
      switch (act) {
        case 'mc': mem = 0; break;
        case 'mr': expr += formatRes(mem); break;
        case 'mplus': mem = mjs.add(mem, value); break;
        case 'mminus': mem = mjs.subtract(mem, value); break;
      }
      localStorage.setItem('calc_mem', String(mem));
      refreshAll();
    }

    document.querySelectorAll('[data-mem]').forEach(btn => {
      btn.addEventListener('click', () => handleMemory(btn.dataset.mem));
    });

    // Eléctrica: deshabilitar el input que sea la target
    ohmTarget.addEventListener('change', () => {
      const t = ohmTarget.value;
      ['ohmV','ohmI','ohmR','ohmP'].forEach(id => {
        const inp = document.getElementById(id);
        inp.disabled = (inp.dataset.var === t);
        if (inp.disabled) inp.value = '';
      });
      document.getElementById('ohmResult').textContent = 'Resultados...';
    });
    ohmTarget.dispatchEvent(new Event('change'));

    // --- Cálculo eléctrico (Ohm + Potencia) ---
    document.getElementById('calcOhm').addEventListener('click', () => {
      const target = ohmTarget.value;
      let V = toNum(document.getElementById('ohmV').value);
      let I = toNum(document.getElementById('ohmI').value);
      let R = toNum(document.getElementById('ohmR').value);
      let P = toNum(document.getElementById('ohmP').value);
      let out = [];

      const known = { V: V != null, I: I != null, R: R != null, P: P != null };
      // ensure at least two known among the allowed ones
      const countKnown = ['V','I','R','P'].filter(k => known[k] && k !== target).length;
      if (countKnown < 2) {
        out.push('⚠️ Rellena dos valores (no la variable objetivo) para calcular.');
      } else {
        let result = null;
        let formula = '';

        // target logic
        if (target === 'V') {
          if (known.I && known.R) { result = I * R; formula = 'V = I × R'; }
          else if (known.P && known.I) { result = P / I; formula = 'V = P / I'; }
          else if (known.P && known.R) { result = Math.sqrt(P * R); formula = 'V = √(P × R)'; }
        } else if (target === 'I') {
          if (known.V && known.R) { result = V / R; formula = 'I = V / R'; }
          else if (known.P && known.V) { result = P / V; formula = 'I = P / V'; }
          else if (known.P && known.R) { result = Math.sqrt(P / R); formula = 'I = √(P / R)'; }
        } else if (target === 'R') {
          if (known.V && known.I) { result = V / I; formula = 'R = V / I'; }
          else if (known.V && known.P) { result = (V * V) / P; formula = 'R = V² / P'; }
          else if (known.P && known.I) { result = P / (I * I); formula = 'R = P / I²'; }
        } else if (target === 'P') {
          if (known.V && known.I) { result = V * I; formula = 'P = V × I'; }
          else if (known.V && known.R) { result = (V * V) / R; formula = 'P = V² / R'; }
          else if (known.I && known.R) { result = I * I * R; formula = 'P = I² × R'; }
        }

        if (result != null && isFinite(result)) {
          out.push(`${target} = ${result.toFixed(6)} ${target === 'V' ? 'V' : target === 'I' ? 'A' : target === 'R' ? 'Ω' : 'W'}`);
          recordHist(histElec, `Calcular ${target}: ${formula}` + ` = ${result.toFixed(6)}`);
        } else {
          out.push('⚠️ No se pudo calcular con esos valores.');
        }
      }
      document.getElementById('ohmResult').textContent = out.join('\n');
    });

    document.getElementById('stepOhm').addEventListener('click', () => {
      const target = ohmTarget.value;
      const V = toNum(document.getElementById('ohmV').value);
      const I = toNum(document.getElementById('ohmI').value);
      const R = toNum(document.getElementById('ohmR').value);
      const P = toNum(document.getElementById('ohmP').value);
      let steps = [];
      if (target === 'none') {
        steps.push('Selecciona la variable que quieres calcular.');
      } else {
        steps.push(`Objetivo: calcular ${target}`);
        const known = { V: V != null, I: I != null, R: R != null, P: P != null };
        const kn = ['V','I','R','P'].filter(k => known[k] && k !== target);
        if (kn.length < 2) {
          steps.push('⚠️ Rellena dos valores entre las restantes.');
        } else {
          const k1 = kn[0], k2 = kn[1];
          let formula = '', result = null;
          if (target === 'V' && known.I && known.R) { formula = 'V = I × R'; result = I * R; }
          else if (target === 'I' && known.V && known.R) { formula = 'I = V / R'; result = V / R; }
          else if (target === 'R' && known.V && known.I) { formula = 'R = V / I'; result = V / I; }
          else if (target === 'P' && known.V && known.I) { formula = 'P = V × I'; result = V * I; }

          if (result != null) {
            steps.push(`Fórmula usada: ${formula}`);
            steps.push(`Sustituyendo: valores conocidos: ${k1} = ${arguments[0]}, ${k2} = ${arguments[1]}`); 
            steps.push(`Resultado: ${target} = ${result.toFixed(6)}`);
          } else {
            steps.push('⚠️ No se encontró fórmula válida para esos valores.');
          }
        }
      }
      document.getElementById('modalContent').textContent = steps.join('\n');
      document.getElementById('modal').style.display = 'flex';
    });

    document.getElementById('clearOhm').addEventListener('click', () => {
      ['ohmV','ohmI','ohmR','ohmP'].forEach(id => {
        const inp = document.getElementById(id);
        inp.value = '';
        inp.disabled = false;
      });
      ohmTarget.value = 'none';
      document.getElementById('ohmResult').textContent = 'Resultados...';
    });

    document.getElementById('clearHistElec').addEventListener('click', () => {
      histElec.length = 0;
      localStorage.setItem('hist_elec', '[]');
      renderHistories();
    });

    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('modal').style.display = 'none';
    });

    // Resistencias serie / paralelo
    function parseList(str) {
      return str.split(',').map(x => toNum(x.trim())).filter(n => n != null);
    }
    document.getElementById('calcSeries').addEventListener('click', () => {
      const list = parseList(document.getElementById('resList').value);
      if (list.length < 1) {
        document.getElementById('resResult').textContent = 'Lista vacía.';
        return;
      }
      const sum = list.reduce((a, b) => a + b, 0);
      document.getElementById('resResult').textContent = `Req serie = ${sum.toFixed(6)} Ω`;
      recordHist(histElec, `Serie: Req = ${sum.toFixed(6)} Ω`);
    });
    document.getElementById('calcParallel').addEventListener('click', () => {
      const list = parseList(document.getElementById('resList').value);
      if (list.length < 1) {
        document.getElementById('resResult').textContent = 'Lista vacía.';
        return;
      }
      const denom = list.reduce((a, b) => a + 1 / b, 0);
      const req = 1 / denom;
      document.getElementById('resResult').textContent = `Req paralela = ${req.toFixed(6)} Ω`;
      recordHist(histElec, `Paralelo: Req = ${req.toFixed(6)} Ω`);
    });
    document.getElementById('stepRes').addEventListener('click', () => {
      const list = parseList(document.getElementById('resList').value);
      let steps = [];
      if (list.length < 1) steps.push('Introduce resistencias válidas separadas por comas.');
      else {
        steps.push(`Resistencias: ${list.join(', ')}`);
        steps.push(`Serie: fórmula = sumatoria; cálculo = ${list.join(' + ')} = ${list.reduce((a,b)=>a+b,0).toFixed(6)}`);
        steps.push(`Paralelo: fórmula = 1 / (∑ 1/R); cálculo = 1 / (${list.map(r => '1/'+r).join(' + ')}) = ${ (1 / list.reduce((a,b)=>a + 1/b, 0)).toFixed(6) }`);
      }
      document.getElementById('modalContent').textContent = steps.join('\n');
      document.getElementById('modal').style.display = 'flex';
    });

    // Reactancia
    document.getElementById('calcReact').addEventListener('click', () => {
      const f = toNum(document.getElementById('freq').value);
      const c = toNum(document.getElementById('cap').value);
      const l = toNum(document.getElementById('ind').value);
      let out = [];
      if (f == null) out.push('Ingresa frecuencia (Hz).');
      if (c != null && f != null) {
        const C = c * 1e-6;
        const Xc = 1 / (2 * Math.PI * f * C);
        out.push(`Xc = ${Xc.toFixed(6)} Ω`);
        recordHist(histElec, `Xc @ ${f}Hz, C=${c}µF = ${Xc.toFixed(6)}`);
      }
      if (l != null && f != null) {
        const L = l * 1e-3;
        const Xl = 2 * Math.PI * f * L;
        out.push(`Xl = ${Xl.toFixed(6)} Ω`);
        recordHist(histElec, `Xl @ ${f}Hz, L=${l}mH = ${Xl.toFixed(6)}`);
      }
      document.getElementById('reactResult').textContent = out.join('\n');
    });
    document.getElementById('stepReact').addEventListener('click', () => {
      const f = toNum(document.getElementById('freq').value);
      const c = toNum(document.getElementById('cap').value);
      const l = toNum(document.getElementById('ind').value);
      let steps = [];
      steps.push(`Frecuencia f = ${f != null ? f : '??'} Hz`);
      if (c != null && f != null) {
        const C = c * 1e-6;
        const Xc = 1 / (2 * Math.PI * f * C);
        steps.push(`Xc fórmula: 1/(2πfC)`);
        steps.push(`Sustituyendo: f=${f}, C=${C} F`);
        steps.push(`Resultado: Xc = ${Xc.toFixed(6)} Ω`);
      }
      if (l != null && f != null) {
        const L = l * 1e-3;
        const Xl = 2 * Math.PI * f * L;
        steps.push(`Xl fórmula: 2πfL`);
        steps.push(`Sustituyendo: f=${f}, L=${L} H`);
        steps.push(`Resultado: Xl = ${Xl.toFixed(6)} Ω`);
      }
      document.getElementById('modalContent').textContent = steps.join('\n');
      document.getElementById('modal').style.display = 'flex';
    });

    // LED resistor
    document.getElementById('calcLed').addEventListener('click', () => {
      const Vs = toNum(document.getElementById('ledV').value);
      const Vf = toNum(document.getElementById('ledVf').value);
      const ImA = toNum(document.getElementById('ledI').value);
      let out = [];
      if (Vs == null || Vf == null || ImA == null) out.push('Rellena Vs, Vf e I.');
      else if (Vs <= Vf) out.push('Vs debe ser > Vf.');
      else {
        const I = ImA / 1000;
        const R = (Vs - Vf) / I;
        const P = (Vs - Vf) * I;
        out.push(`R ≈ ${R.toFixed(4)} Ω`);
        out.push(`P ≈ ${P.toFixed(6)} W`);
        recordHist(histElec, `LED: R=${R.toFixed(4)}Ω, P=${P.toFixed(6)}W`);
      }
      document.getElementById('ledResult').textContent = out.join('\n');
    });
    document.getElementById('stepLed').addEventListener('click', () => {
      const Vs = toNum(document.getElementById('ledV').value);
      const Vf = toNum(document.getElementById('ledVf').value);
      const ImA = toNum(document.getElementById('ledI').value);
      let steps = [];
      if (Vs == null || Vf == null || ImA == null) steps.push('Completa Vs, Vf e I.');
      else {
        steps.push('Fórmula: R = (Vs − Vf) / I');
        steps.push(`Sustituyendo: ( ${Vs} − ${Vf} ) / ${ImA/1000}`);
        const R = (Vs - Vf) / (ImA / 1000);
        steps.push(`Resultado: R = ${R.toFixed(4)} Ω`);
      }
      document.getElementById('modalContent').textContent = steps.join('\n');
      document.getElementById('modal').style.display = 'flex';
    });

    // Joule
    document.getElementById('calcJoule').addEventListener('click', () => {
      const I = toNum(document.getElementById('jouleI').value);
      const R = toNum(document.getElementById('jouleR').value);
      const t = toNum(document.getElementById('jouleT').value);
      if (I == null || R == null || t == null) {
        document.getElementById('jouleResult').textContent = 'Rellena I, R y t.';
      } else {
        const Q = I * I * R * t;
        document.getElementById('jouleResult').textContent = `Q = ${Q.toFixed(6)} J`;
        recordHist(histElec, `Joule: Q=${Q.toFixed(6)}J`);
      }
    });
    document.getElementById('stepJoule').addEventListener('click', () => {
      const I = toNum(document.getElementById('jouleI').value);
      const R = toNum(document.getElementById('jouleR').value);
      const t = toNum(document.getElementById('jouleT').value);
      let steps = [];
      if (I == null || R == null || t == null) steps.push('Rellena I, R y t.');
      else {
        const Q = I * I * R * t;
        steps.push('Fórmula: Q = I² × R × t');
        steps.push(`Sustituyendo: (${I})² × ${R} × ${t}`);
        steps.push(`Resultado: Q = ${Q.toFixed(6)} J`);
      }
      document.getElementById('modalContent').textContent = steps.join('\n');
      document.getElementById('modal').style.display = 'flex';
    });

    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('modal').style.display = 'none';
    });

    // Graficador
    document.getElementById('plotBtn').addEventListener('click', () => {
      const exprF = document.getElementById('funcExpr').value;
      const xmin = toNum(document.getElementById('xMin').value) ?? -10;
      const xmax = toNum(document.getElementById('xMax').value) ?? 10;
      const canvas = document.getElementById('plotCanvas');
      const ctx = canvas.getContext('2d');
      if (!exprF || xmin >= xmax) { alert('Verifica la función y el rango'); return; }
      canvas.width = canvas.clientWidth;
      canvas.height = 300;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const N = canvas.width * 2;
      let ys = [], xs = [];
      let ymin = Infinity, ymax = -Infinity;

      try {
        const code = mjs.parse(exprF).compile();
        for (let i = 0; i < N; i++) {
          const x = xmin + (xmax - xmin) * (i / (N - 1));
          let y = code.evaluate({ x: x });
          if (typeof y === 'object' && y.re != null) y = y.re;
          if (!isFinite(y)) { ys.push(null); xs.push(x); continue; }
          ys.push(y); xs.push(x);
          ymin = Math.min(ymin, y);
          ymax = Math.max(ymax, y);
        }
        if (ymin === Infinity || ymax === -Infinity) { alert('No se pudo evaluar la función.'); return; }
        const padding = (ymax - ymin) * 0.1;
        ymin -= padding; ymax += padding;
        const tx = x => (x - xmin) / (xmax - xmin) * canvas.width;
        const ty = y => canvas.height - (y - ymin) / (ymax - ymin) * canvas.height;

        // Ejes
        ctx.strokeStyle = '#2b3a4a'; ctx.lineWidth = 1;
        if (ymin < 0 && ymax > 0) { ctx.beginPath(); ctx.moveTo(0, ty(0)); ctx.lineTo(canvas.width, ty(0)); ctx.stroke(); }
        if (xmin < 0 && xmax > 0) { ctx.beginPath(); ctx.moveTo(tx(0), 0); ctx.lineTo(tx(0), canvas.height); ctx.stroke(); }

        // Graficar curva
        ctx.strokeStyle = '#0ea5a6'; ctx.lineWidth = 2;
        ctx.beginPath();
        let started = false;
        for (let i = 0; i < N; i++) {
          const y = ys[i];
          if (y == null) { started = false; continue; }
          const px = tx(xs[i]);
          const py = ty(y);
          if (!started) { ctx.moveTo(px, py); started = true; }
          else { ctx.lineTo(px, py); }
        }
        ctx.stroke();
        recordHist(histElec, `Graficar: ${exprF} en [${xmin},${xmax}]`);
      } catch (e) {
        alert('Error graficando: ' + e.message);
        console.error(e);
      }
    });
    document.getElementById('clearPlot').addEventListener('click', () => {
      const canvas = document.getElementById('plotCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // init
    refreshAll();
  </script>
</body>
</html>
