<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üõ†Ô∏è HeavyDiag - Dashboard T√©cnico v19.4 (API Corregida)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- ESTILOS MODERNOS (v19.4 - Sin cambios visuales) --- */
  :root {
    --primary-color: #f5b74f; /* Naranja Minero */
    --secondary-color: #1f2937; /* Azul Oscuro Base */
    --background-color: #111827; /* Fondo General Muy Oscuro */
    --panel-background: #0f172a; /* Paneles Laterales/Modales */
    --card-background: #1e2632; /* Tarjetas Individuales */
    --text-color: #e5e7eb; /* Texto Principal Blanco Roto */
    --text-muted: #9ca3af; /* Texto Secundario Gris */
    --border-color: #374151; /* Borde Suave */
    --highlight-border: #4b5563; /* Borde Hover/Focus */
    --danger-color: #ef4444; /* Rojo */
    --warning-color: #facc15; /* Amarillo Atacama/Warning */
    --success-color: #10b981; /* Verde */
    --info-color: #3b82f6; /* Azul Info */
    --gestion-color: #8b5cf6; /* Morado (para gesti√≥n) */
    --advan-color: #f97316; /* Naranja Oscuro (para avanzado) */
    --border-radius: 8px;
    --box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    --transition-speed: 0.25s;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    min-height: 100vh;
    display: flex;
    font-size: 15px;
    line-height: 1.6;
    overflow: hidden; /* Evita scroll principal */
  }
  .app-layout { display: flex; width: 100%; height: 100vh; }
  .sidebar {
    width: 280px; background: var(--panel-background); padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid var(--border-color); overflow-y: auto; transition: width var(--transition-speed);
  }
  .sidebar h1 {
    color: var(--primary-color); font-size: 1.6rem; font-weight: 700; text-align: center; margin-bottom: 10px;
  }
  .sidebar h3 {
      color: var(--primary-color); margin-bottom: 10px; margin-top: 15px; font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;
  }
  .btn {
    display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 6px; background: var(--card-background); border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; font-size: 0.9rem; transition: background var(--transition-speed), border-color var(--transition-speed); text-align: left; width: 100%;
  }
  .btn:hover {
    background: var(--secondary-color); border-color: var(--highlight-border);
  }
   .btn:disabled {
    opacity: 0.5; cursor: not-allowed;
  }
  .btn.primary {
    background: var(--info-color); border-color: var(--info-color); color: #fff;
  }
  .btn.primary:hover { background: #2563eb; }
  .btn i { width: 16px; text-align: center; }
  .filters { display: grid; gap: 10px; }
  input[type="search"], select {
    width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--secondary-color); color: var(--text-color); font-size: 0.9rem;
  }
  input[type="search"]:focus, select:focus {
    outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(245, 183, 79, 0.3);
  }
  .chip {
    display: inline-block; padding: 4px 10px; border-radius: 999px; background: var(--secondary-color); color: var(--text-muted); font-size: 0.8rem; border: 1px solid var(--border-color);
  }
  .toggle-label {
    display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; color: var(--text-muted);
  }
  .toggle-label input[type="checkbox"] { margin-right: 5px; }
  .note {
    background: var(--secondary-color); padding: 10px; border-radius: 6px; border-left: 4px solid var(--primary-color); color: var(--text-muted); font-size: 0.85rem; margin-top: 10px;
  }
  .main-content {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
  .main-header {
    padding: 12px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--panel-background); flex-shrink: 0;
  }
  #globalSearchInputHeader {
    width: 350px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--secondary-color); color: var(--text-color);
  }
   #globalSearchInputHeader:focus {
     outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(245, 183, 79, 0.3);
  }
  .results-area {
    padding: 20px; overflow-y: auto; flex-grow: 1;
  }
  .results-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--text-muted); font-size: 0.9rem;
  }
  .results-summary { display: flex; gap: 10px; }
  .cards-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;
  }
  .card {
    background: var(--card-background); padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); transition: transform var(--transition-speed), box-shadow var(--transition-speed); cursor: pointer; min-height: 120px; display: flex; flex-direction: column; position: relative; overflow: hidden;
  }
   .card:hover {
    transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4); border-color: var(--highlight-border);
  }
   .card h4 {
    color: var(--primary-color); margin-bottom: 8px; font-size: 1.05rem; font-weight: 600; display: flex; align-items: center; gap: 8px;
  }
   .card h4 .icon { font-size: 1.5rem; line-height: 1; }
   .card .muted { color: var(--text-muted); font-size: 0.9rem; flex-grow: 1; margin-bottom: 10px; }
   .card .tags { margin-top: auto; display: flex; flex-wrap: wrap; gap: 5px; }
   .card .tag { background: var(--panel-background); color: #a5b4fc; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid var(--border-color); }
   .card .tag.code-tag { background: #4b5563; color: #e0e7ff; }
  .card.severity-high { border-left: 5px solid var(--danger-color); }
  .card.severity-medium { border-left: 5px solid var(--warning-color); }
  .card.severity-warning { border-left: 5px solid var(--warning-color); } 
  .card.severity-low { border-left: 5px solid var(--info-color); }
  .card.severity-success { border-left: 5px solid var(--success-color); }
  .card.loading-card {
      background: var(--secondary-color);
      border-style: dashed;
      justify-content: center;
      align-items: center;
      cursor: progress;
      padding: 20px;
  }
  .card.loading-card h4 { color: var(--text-muted); margin: 0; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loader-icon {
      font-size: 1.5rem;
      color: var(--primary-color);
      animation: spin 1.5s linear infinite;
      margin-bottom: 10px;
  }
  .diagnosis-panel-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px;
  }
  .diagnosis-panel {
    background: var(--panel-background); border: 1px solid var(--highlight-border); border-radius: var(--border-radius); padding: 25px; width: 100%; max-width: 850px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.6); position: relative; display: flex; flex-direction: column; gap: 15px; animation: fadeInModal 0.3s ease-out;
  }
  @keyframes fadeInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .diagnosis-panel h2 {
      color: var(--primary-color); font-size: 1.5rem; margin-bottom: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; gap: 10px;
  }
   .diagnosis-panel h2 .icon { font-size: 1.8rem; line-height: 1; }
   .diagnosis-panel .info-card {
      background: var(--secondary-color); margin-bottom: 0; border-radius: 6px; padding: 15px; position: relative;
  }
   .diagnosis-panel .info-card h4 {
      font-size: 1.1rem; margin-bottom: 8px; display: flex; align-items: center;
   }
   .diagnosis-panel .info-card h4 i { margin-right: 8px; width: 18px; text-align: center; }
   .diagnosis-panel ul, .diagnosis-panel ol { margin-left: 15px; padding-left: 10px; }
   .diagnosis-panel li { margin-bottom: 6px; font-size: 0.95rem; }
   .diagnosis-panel p { font-size: 0.95rem; }
   .diagnosis-panel pre { background: var(--background-color); font-size: 0.85em; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
   .diagnosis-panel code { background: var(--card-background); }
   .diagnosis-panel .close-btn {
       position: absolute; top: 15px; right: 15px; background: var(--card-background); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; z-index: 10;
   }
   .diagnosis-panel .close-btn:hover { background: var(--secondary-color); }
   .btn-ai-explain {
       position: absolute; top: 10px; right: 10px; font-size: 0.75rem; padding: 3px 8px; background: var(--info-color); color: white; border: none; border-radius: 4px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
   }
   .btn-ai-explain:hover { opacity: 1; background: #2563eb; }
   .btn-ai-explain i { margin-right: 4px; }
   .info-card.alert-safety { border-left-color: var(--danger-color); background: rgba(239, 68, 68, 0.1); color: #fecaca; }
   .info-card.alert-safety h4 { color: var(--danger-color); }
   .info-card.alert-engineer { border-left-color: var(--success-color); background: rgba(16, 185, 129, 0.1); color: #a7f3d0; }
   .info-card.alert-engineer h4 { color: var(--success-color); }
   .info-card.gestion-card { border-left-color: var(--gestion-color); }
   .info-card.gestion-card h4 { color: var(--gestion-color); }
   .info-card.specs-card { border-left-color: #06b6d4; }
   .info-card.specs-card h4 { color: #06b6d4;}
   .info-card.advanced-card { border-left-color: var(--advan-color); }
   .info-card.advanced-card h4 { color: var(--advan-color); }
   .info-card.codes-list { border-left-color: var(--info-color); }
   .info-card.codes-list h4 { color: var(--info-color); }
   .info-card.codes-list code { background: #374151; color: #a5b4fc; padding: 3px 6px; border-radius: 4px; border: 1px solid #4b5563; }
   .atacama-note {
    border-left-color: #facc15; background: #494917; color: #fde047; display: none; border: 1px solid #eab308;
  }
  .atacama-note h4 { color: #facc15; }
  .diagnosis-panel.show-atacama .atacama-note { display: block; }
  footer {
    padding: 10px; text-align: center; font-size: 0.8rem; color: var(--text-muted); border-top: 1px solid var(--border-color); background: var(--panel-background); margin-top: auto; flex-shrink: 0;
  }
  .hidden { display: none; }
  ::-webkit-scrollbar { width: 10px; height: 10px; }
  ::-webkit-scrollbar-track { background: var(--secondary-color); border-radius: 5px; }
  ::-webkit-scrollbar-thumb { background: var(--highlight-border); border-radius: 5px; border: 2px solid var(--secondary-color); }
  ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
  @media (max-width: 1024px) { .sidebar { width: 240px; } }
  @media (max-width: 768px) {
    body { flex-direction: column; overflow: auto; }
    .app-layout { flex-direction: column; height: auto; }
    .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); height: auto; max-height: 40vh; overflow-y: auto; }
    .main-header { padding: 10px 15px; flex-direction: column; gap: 10px; }
    #globalSearchInputHeader { width: 100%; }
    .results-area { padding: 15px; }
    .cards-grid { grid-template-columns: 1fr; }
    .diagnosis-panel-overlay { padding: 10px; }
    .diagnosis-panel { width: 100%; max-height: 90vh; padding: 15px; }
    .diagnosis-panel h2 { font-size: 1.3rem; }
    .diagnosis-panel .info-card { padding: 12px; }
    .diagnosis-panel .info-card h4 { font-size: 1rem; }
    .action-buttons { flex-direction: column; gap: 10px; }
    .search-btn { width: 100%; text-align: center; justify-content: center; }
  }
  @media print {
    body { background: #fff; color: #000; padding: 0; font-size: 10pt; }
    .app-layout, .sidebar, .main-header, .results-area, footer, .action-buttons, .close-btn, #btnOpenGoogleDiagModal, #copyDiagnosisBtn, #exportDiagnosisBtn, #printDiagnosisBtn { display: none !important; }
    .diagnosis-panel-overlay { position: static; background: none; backdrop-filter: none; padding: 0; display: block !important; }
    .diagnosis-panel { display: block !important; width: 100%; max-width: none; max-height: none; overflow: visible; box-shadow: none; border: none; padding: 0; animation: none; }
    .info-card { background: #f8f9fa; color: #333; border-left-width: 3px; box-shadow: none; page-break-inside: avoid; margin-bottom: 15px; }
    .alert-safety, .alert-engineer { background: #eee; color: #000; font-weight: normal; }
    pre, code { background: #eee; color: #333; border: 1px solid #ccc; font-size: 9pt; word-wrap: break-word; white-space: pre-wrap; }
    a { text-decoration: none; color: inherit; }
    h2, h4 { color: #000; border-bottom: 1px solid #ccc; }
    ul, ol { margin-left: 15px; padding-left: 5px; }
    li { margin-bottom: 4px; }
    .btn-ai-explain { display: none; }
  }
</style>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar">
      <h1><i class="fas fa-wrench"></i> HeavyDiag</h1>

      <h3><i class="fas fa-filter"></i> Filtros</h3>
      <div class="filters">
        <input id="globalSearchInputSidebar" type="search" placeholder="Buscar o preguntar...">
        <select id="typeFilter">
          <option value="">-- Tipo de Maquinaria --</option>
        </select>
        <select id="subsystemFilter">
          <option value="">-- Subsistema --</option>
          <option value="inyeccion">Inyecci√≥n / Combustible</option>
          <option value="hidraulico">Hidr√°ulico</option>
          <option value="electrico">El√©ctrico / Tracci√≥n</option>
          <option value="transmision">Transmisi√≥n / Ejes</option>
          <option value="sistemas_aux">Sistemas Auxiliares</option>
          <option value="motor">Motor General</option>
          <option value="chasis">Chasis/Estructura/Implemento</option>
          <option value="frenos">Frenos / Retardo</option>
          <option value="direccion">Direcci√≥n</option>
          <option value="tren_rodaje">Tren de Rodaje / Neum√°ticos</option>
          <option value="diagnostico">M√©todos Diagn√≥stico</option>
        </select>
        <button class="btn" id="btnResetFilters"><i class="fas fa-undo"></i> Limpiar Filtros</button>
      </div>

      <h3><i class="fas fa-tools"></i> Herramientas</h3>
      <button class="btn primary" id="btnShowAll"><i class="fas fa-list"></i> Mostrar Todo</button>
      <label class="toggle-label"><input type="checkbox" id="toggleAtacama"> <span class="chip"><i class="fas fa-mountain-sun"></i> Modo Atacama</span></label>
      <label class="toggle-label"><input type="checkbox" id="reviewBeforeExport" checked> <i class="fas fa-clipboard-check"></i> Revisar antes de exportar</label>
      <button class="btn" id="btnExport"><i class="fas fa-file-export"></i> Exportar Resultados</button>

      <h3><i class="fas fa-chart-line"></i> An√°lisis</h3>
      <button class="btn" id="btnShowKPIs"><i class="fas fa-tachometer-alt"></i> KPIs y Predicci√≥n</button>
      <button class="btn" id="btnShowDiagTech"><i class="fas fa-microscope"></i> T√©cnicas Avanzadas</button>

      <h3><i class="fas fa-info-circle"></i> Info</h3>
      <div class="note">
        <p><strong>Total Registros:</strong> <span id="totalCount">--</span></p>
        <p><strong>Modo Atacama:</strong> Muestra notas para condiciones des√©rticas.</p>
      </div>
      
      <footer style="margin-top: auto; font-size: 0.8rem; color: #6b7280; text-align: center;">
          v19.4 - API v1
      </footer>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <input id="globalSearchInputHeader" type="search" placeholder="Buscar aver√≠a, s√≠ntoma, c√≥digo, o preguntar (ej: motor con agua)...">
        <div class="chips-display" style="display: flex; gap: 8px;">
            <div class="chip" id="currentModeDisplay">Modo: Normal</div>
            <div class="chip" id="loadedSourceDisplay">Fuente: Fusionada</div>
        </div>
      </header>

      <div class="results-area">
         <div class="results-header">
             <div class="results-summary">
                 <span class="chip"><i class="fas fa-exclamation-triangle"></i> <span id="foundCount">0</span> Resultados</span>
                 <span class="chip"><i class="fas fa-car-side"></i> <span id="uniqueModels">0</span> Modelos</span>
             </div>
             <span>Hecho por HeavyDiag</span>
         </div>
         <div id="cardsGrid" class="cards-grid">
             <template id="loadingCardTemplate">
                <div class="card loading-card">
                    <i class="fas fa-spinner loader-icon"></i>
                    <h4>Consultando IA...</h4>
                    <p class="muted">Generando diagn√≥stico para "<span class="loading-query"></span>"</p>
                </div>
             </template>
             
             <div class="card"><h4>Bienvenido a HeavyDiag</h4><p class="muted">Usa los filtros o la barra de b√∫squeda para encontrar informaci√≥n sobre fallas, diagn√≥sticos o preguntar sobre escenarios comunes (ej: "motor con agua" con un tipo de m√°quina seleccionado).</p></div>
         </div>
      </div>

    </main>
  </div>

  <div id="diagnosisPanelOverlay" class="diagnosis-panel-overlay">
      <div id="diagnosisPanel" class="diagnosis-panel">
          <button id="closeDiagnosisPanelBtn" class="close-btn" aria-label="Cerrar"><i class="fas fa-times"></i></button>
          <h2 id="diagTitle"><span class="icon">?</span>Diagn√≥stico Detallado</h2>
          <div id="diagContent">
              </div>
          <div class="action-buttons" style="margin-top: 15px;">
              <a id="btnOpenGoogleDiagModal" class="btn primary" href="#" target="_blank" rel="noopener noreferrer"><i class="fab fa-google"></i> Buscar en Google</a>
              <button class="btn" id="copyDiagnosisBtn"><i class="fas fa-copy"></i> Copiar Info</button>
              <button class="btn" id="exportDiagnosisBtn"><i class="fas fa-file-export"></i> Exportar Falla</button>
              <button class="btn" id="printDiagnosisBtn"><i class="fas fa-print"></i> Imprimir</button>
          </div>
      </div>
  </div>

<script>
/* ========================================================================= */
/* HEAVYDIAG - DATOS Y L√ìGICA (v19.4 - API v1 Corregida)                   */
/* ========================================================================= */

// --- BASE DE DATOS ---
const machineTypes = { /* ... (igual que v19.3) ... */ 
    camioneta: { name: "Camioneta Minera", icon: "üõª", description: "Hilux, Ranger, F-150..." },
    retroexcavadora: { name: "Retroexcavadora", icon: "üöú", description: "Komatsu, CAT, JD, JCB..." },
    excavadora: { name: "Excavadora", icon: "<i class='fas fa-mountain-city'></i>", description: "CAT, Komatsu, Volvo, Hitachi..." },
    cargador: { name: "Cargador Frontal", icon: "<i class='fas fa-cubes-stacked'></i>", description: "CAT, Komatsu, Volvo, Kawasaki..." },
    dumper: { name: "Cami√≥n Minero", icon: "<i class='fas fa-truck-monster'></i>", description: "CAT, Komatsu, Belaz, Volvo..." },
    bulldozer: { name: "Bulldozer", icon: "<i class='fas fa-tractor'></i>", description: "CAT, Komatsu, Liebherr..." },
    motoniveladora: { name: "Motoniveladora", icon: "<i class='fas fa-road'></i>", description: "CAT, Komatsu, JD..." },
    pala: { name: "Pala Hidr√°ulica/El√©ctrica", icon: "<i class='fas fa-person-digging'></i>", description: "CAT, Komatsu, Liebherr, Bucyrus..." },
    perforadora: { name: "Perforadora Rotativa", icon: "<i class='fas fa-bore-hole'></i>", description: "Sandvik, Atlas Copco..." },
    compactador: { name: "Compactador Vibratorio", icon: "<i class='fas fa-road-roller'></i>", description: "BOMAG, CAT, Hamm..." },
    tbm: { name: "Tuneladora (TBM)", icon: "<i class='fas fa-train-tunnel'></i>", description: "Herrenknecht..." },
    dragalina: { name: "Dragalina", icon: "<i class='fas fa-ship'></i>", description: "Bucyrus..." },
    spreader: { name: "Spreader (Extensor)", icon: "<i class='fas fa-truck-loading'></i>", description: "TAKRAF..." },
    reclaimer: { name: "Reclaimer (Recuperador)", icon: "<i class='fas fa-recycle'></i>", description: "Sandvik..." },
    shiploader: { name: "Ship Loader (Cargador Barcos)", icon: "<i class='fas fa-anchor'></i>", description: "Siemens..." },
    harvester: { name: "Harvester (Forestal)", icon: "<i class='fas fa-tree'></i>", description: "John Deere..." },
    forwarder: { name: "Forwarder (Forestal)", icon: "<i class='fas fa-truck-pickup'></i>", description: "Caterpillar..." },
    cisterna: { name: "Cami√≥n Cisterna", icon: "<i class='fas fa-gas-pump'></i>", description: "Mercedes, Volvo, Scania..." },
    zanjadora: { name: "Zanjadora", icon: "<i class='fas fa-mound'></i>", description: "Vermeer, Trencor..." },
    planta_asfalto: { name: "Planta de Asfalto", icon: "<i class='fas fa-industry'></i>", description: "Marini, Astec..." },
    compresor: { name: "Compresor de Aire", icon: "<i class='fas fa-compress'></i>", description: "Atlas Copco, IR..." },
    generador: { name: "Generador Diesel", icon: "<i class='fas fa-bolt'></i>", description: "CAT, Cummins..." },
    diagnostico: { name: "M√©todos Diagn√≥stico", icon: "<i class='fas fa-stethoscope'></i>", description:"Vibraciones, Aceite, Termograf√≠a..."}
};

const allFailuresData = { /* ... (La base de datos completa de gemini.txt v16 va aqu√≠. Es demasiado grande para repetirla, pero se asume que est√° completa) ... */ 
    // --- CAMIONETAS (Datos de todas las fuentes) ---
    hilux: [
        { id: 101, name: "Sistema Inyecci√≥n Diesel", initial: "P√©rdida de potencia, humo negro/blanco, arranque dif√≠cil.", modelosAplicables: ["Toyota Hilux 2.4L/2.8L"], alertaSeguridad: "No manipular inyectores con motor en marcha (alta presi√≥n).", symptoms: ["P√©rdida potencia progresiva", "Humo negro (acelerar)", "Humo blanco (arranque fr√≠o)", "Consumo >12L/100km", "Arranque dif√≠cil fr√≠o", "Ralent√≠ inestable"], causes: ["Inyectores obstruidos/desgastados", "Filtro combustible saturado", "Bomba alta presi√≥n (HP) defectuosa", "Sensor MAF sucio", "V√°lvula EGR carbonizada", "Turbo con juego excesivo", "Combustible contaminado"], diagnosticSteps: ["1. Escanear c√≥digos OBD2.", "2. Verificar presi√≥n riel com√∫n (1350-1800 bar).", "3. Prueba retorno inyectores (<1.5L/min total).", "4. Medir resistencia inyectores (0.3-0.5 ohms).", "5. Verificar se√±al MAF (2.5-3.5V ralent√≠).", "6. Inspeccionar juego turbo (<0.05mm radial)."], solution: ["Limpieza/reemplazo inyectores", "Cambio filtro combustible", "Reemplazo bomba HP", "Limpieza MAF/EGR", "Reparaci√≥n/reemplazo turbo", "Calibraci√≥n con esc√°ner Toyota"], costoEstimado: "US$ 100 (filtro) - US$ 3,000+ (inyectores/bomba)", searchTerms: "toyota hilux diesel inyector perdida potencia humo negro", codes: ["P0087", "P0093", "P0191", "P0201-P0204", "P2146"], datoIngeniero: "La presi√≥n Common Rail en Hilux es muy alta, cualquier contaminaci√≥n afecta el rendimiento.", prevention: ["Cambio de combustible cada 6 meses si no se usa", "Usar aditivo limpiador cada 10,000 km", "Evitar quedarse sin combustible", "Calentar motor antes de exigir potencia m√°xima", "Cambiar filtro combustible cada 20,000 km"] },
        { id: 102, name: "Transmisi√≥n Autom√°tica", initial: "Cambios bruscos, deslizamiento, sobrecalentamiento.", modelosAplicables: ["Toyota Hilux (Autom√°tica)"], symptoms: ["Golpe al cambiar P->D o R", "Deslizamiento en subidas", "No entra marcha despu√©s de calentar", "Temperatura ATF >120¬∞C", "Ruido zumbido"], causes: ["Nivel bajo ATF", "Filtro ATF obstruido", "Solenoides cambio defectuosos", "Clutch desgastado", "M√≥dulo TCM fallando", "Enfriador ATF tapado"], diagnosticSteps: ["1. Verificar nivel ATF (motor caliente, neutro).", "2. Revisar color/olor ATF (rojo limpio vs caf√© quemado).", "3. Medir temperatura con esc√°ner.", "4. Prueba presi√≥n l√≠nea (10-12 bar).", "5. Escanear c√≥digos TCM.", "6. Prueba stall (<2500 RPM)."], solution: ["Cambio ATF + filtro (usar Toyota ATF WS)", "Reemplazo solenoides", "Limpieza enfriador", "Overhaul si hay da√±o interno"], costoEstimado: "US$ 200 (cambio aceite) - US$ 4,000 (Overhaul)", searchTerms: "transmision automatica hilux cambios bruscos patina", codes: ["P0734", "P0750", "P0841", "P0715"], prevention:["Cambio ATF+filtro cada 60,000 km", "Usar exclusivamente Toyota ATF WS"] },
        { id: 110, name: "Chasis Fisurado (Zona Trasera)", initial:"Ruido ('clack') al pasar baches, posible desnivel.", modelosAplicables: ["Toyota Hilux"], alertaSeguridad:"Inspecci√≥n estructural URGENTE. Riesgo de colapso.", symptoms:["Ruido estructural", "Desnivel caja carga", "Fisuras visibles cerca soportes ballestas"], causes:["Fatiga material por sobrecarga/torsi√≥n constante", "Corrosi√≥n"], diagnosticSteps:["1. Limpieza profunda chasis.", "2. Inspecci√≥n visual detallada (especialmente sobre eje trasero).", "3. Prueba l√≠quidos penetrantes si se sospecha fisura fina."], solution:["Reparaci√≥n estructural por soldador calificado (seguir procedimiento fabricante)", "Instalar kit refuerzo chasis"], costoEstimado:"US$ 500 - $3,000+", searchTerms:"chasis fisurado hilux reparacion", codes:[], prevention:["No sobrecargar", "Inspecci√≥n chasis cada 20,000 km"] },
    ],
    ranger: [
        { id: 201, name: "Enfriador EGR Fisurado (3.2L)", initial: "P√©rdida de refrigerante, riesgo sobrecalentamiento.", modelosAplicables: ["Ford Ranger 3.2L"], alertaSeguridad: "Verificar nivel refrigerante. No operar si recalienta.", symptoms:["Baja nivel refrigerante sin fuga visible", "Humo blanco (si fuga es grande)", "Sobrecalentamiento"], causes:["Fisura interna enfriador EGR"], diagnosticSteps:["1. Prueba presi√≥n sistema enfriamiento.", "2. Verificar si hay refrigerante en admisi√≥n/escape.", "3. Desmontar e inspeccionar enfriador EGR."], solution:["Reemplazo del enfriador EGR"], costoEstimado:"US$ 400 - $800", searchTerms:"ford ranger 3.2 egr cooler leak perdida refrigerante", codes:["P0401", "P0402"] },
        { id: 107, name: "Inyectores con Fugas Internas (3.2L)", initial: "Arranque dif√≠cil, humo blanco, nivel aceite SUBE.", modelosAplicables: ["Ford Ranger 3.2L"], alertaSeguridad: "‚ö†Ô∏è Si nivel aceite sube, ¬°NO ARRANCAR! Riesgo motor desbocado.", symptoms: ["Arranque dif√≠cil (especialmente caliente)", "Humo blanco excesivo", "Nivel aceite sube", "Aceite huele a diesel", "Ralent√≠ inestable"], causes: ["Sellos internos inyector desgastados (Delphi)", "Alto kilometraje (+150k km)"], diagnosticSteps: ["1. ¬°Verificar nivel y OLOR aceite!", "2. Prueba retorno inyectores.", "3. Escanear c√≥digos.", "4. An√°lisis aceite (diluci√≥n)."], solution: ["Reemplazo URGENTE inyectores fugando", "Cambio aceite+filtro", "Usar inyectores Bosch (opcional, m√°s fiables)"], costoEstimado: "US$ 400 - US$ 700 por inyector", searchTerms: "inyector ford ranger 3.2 fuga interna nivel aceite sube", codes: ["P0201-P0205", "P0267"], prevention:["Verificar nivel aceite frecuentemente", "Cambio filtro combustible seg√∫n pauta"] },
    ],
    f150: [
        { id: 901, name: "Turbos EcoBoost - Enfriamiento", initial:"P√©rdida potencia altas RPM, silbido agudo, humo.", modelosAplicables:["Ford F-150 Raptor 3.5L"], alertaSeguridad:"Riesgo da√±o turbo si sobrecalienta.", severity: "medium", symptoms:["P√©rdida potencia", "Silbido", "Humo blanco/azul", "Consumo aceite", "Sobrecalentamiento (arena)"], causes:["Intercooler obstruido (polvo)", "Wastegates carbonizadas", "Aceite incorrecto (Usar 5W-50)", "Juntas turbo", "Enfriamiento insuficiente"], diagnosticSteps:["1. Medir presi√≥n boost (1.8-2.0 bar).", "2. Verificar wastegates.", "3. Inspeccionar intercooler (aceite).", "4. Escanear c√≥digos."], solution:["Limpieza intercooler", "Reemplazo juntas", "Actualizar software PCM", "Intercooler mejorado"], costoEstimado:"US$ 200 (limpieza) - $1,500+ (intercooler)", searchTerms:"ford f150 raptor ecoboost perdida potencia turbo", codes:["P0299", "P0234"], prevention:["Limpieza intercooler cada 20k km (miner√≠a)"], atacamaNotes:"Requiere intercooler de mayor capacidad para altitud y calor." }
    ],
    ram1500: [
        { id: 951, name: "Sistema EGR EcoDiesel", initial:"P√©rdida potencia progresiva, consumo alto, regeneraciones DPF frecuentes.", modelosAplicables:["RAM 1500 3.0L Ecodiesel"], severity: "medium", symptoms:["P√©rdida potencia", "Consumo alto", "Regeneraciones DPF", "Humo gris"], causes:["Enfriador EGR obstruido", "V√°lvula EGR trabada", "Software"], diagnosticSteps:["1. Medir presi√≥n diferencial EGR.", "2. Medir temp. gases EGR.", "3. Analizar gases pre/post EGR.", "4. Escanear c√≥digos."], solution:["Limpieza ultras√≥nica cooler EGR", "Reprogramaci√≥n ECU", "Reemplazo v√°lvula EGR", "EGR delete (solo off-road)"], costoEstimado:"US$ 300 (limpieza) - $1,000 (reemplazo)", searchTerms:"ram 1500 ecodiesel egr cooler falla", codes:["P0401", "P0404"], atacamaNotes:"La baja humedad y polvo fino pueden acelerar obstrucci√≥n. Limpieza preventiva cada 40k km." }
    ],
     jd_retro: [
        { id: 2301, name: "Convertidor de Torque Slippage", initial:"RPM suben pero m√°quina no avanza o lo hace lentamente.", modelosAplicables:["John Deere 310SL/310L"], alertaSeguridad:"Sobrecalentamiento transmisi√≥n cr√≠tico.", severity: "high", symptoms:["RPM sube sin avance", "Temperatura transmisi√≥n >115¬∞C", "Olor a aceite quemado", "P√©rdida fuerza en pendiente"], causes:["Desgaste interno convertidor", "Baja presi√≥n clutch", "Filtro/refrigeraci√≥n transmisi√≥n insuficiente", "Aceite bajo/quemado"], diagnosticSteps:["1. Prueba stall (No debe exceder 2200 RPM).", "2. Medir presi√≥n clutch/modulaci√≥n.", "3. An√°lisis espectrosc√≥pico aceite transmisi√≥n.", "4. Verificar enfriador."], solution:["Overhaul/reemplazo convertidor de torque", "Upgrade kit refrigeraci√≥n transmisi√≥n", "Cambio aceite (JD Hy-Gard) + filtro"], costoEstimado:"US$ 3,500 - $6,000 (Convertidor)", searchTerms:"john deere 310sl torque converter slippage patina", codes:[], prevention:["An√°lisis aceite cada 500h", "Cambio filtro cada 1000h"] },
    ],
     cat_retro: [
        { id: 203, name: "Bomba Hidr√°ulica Pistones", initial:"Movimientos lentos, p√©rdida fuerza, ruido bomba.", modelosAplicables: ["416E", "420F", "430F", "446", "450"], severity: "medium", symptoms: ["Lentitud general", "Sin fuerza excavaci√≥n", "Ruido chill√≥n/golpeteo", "Aceite caliente (>90¬∞C)", "Espuma aceite"], causes: ["Desgaste interno bomba", "Filtro hidr√°ulico saturado", "Aceite incorrecto/viejo (Usar HYDO Adv 10)", "Cavitaci√≥n", "V√°lvula alivio mal calibrada", "Acople bomba-motor"], diagnosticSteps: ["1. Medir presi√≥n principal (3000-3600 PSI).", "2. Medir presi√≥n piloto (500-700 PSI).", "3. Verificar temp. aceite.", "4. Inspeccionar filtros (part√≠culas metal).", "5. Prueba carga.", "6. Verificar RPM motor."], solution: ["Overhaul/reemplazo bomba", "Cambio aceite (CAT HYDO Adv 10) + filtros", "Limpieza tanque", "Purgar aire", "Calibrar v√°lvula alivio"], costoEstimado: "US$ 3,000 (Overhaul) - US$ 10,000 (Nueva)", searchTerms: "caterpillar 416e 420f bomba hidraulica lenta ruido", codes: ["094-03", "100-03"], prevention:["Cambio aceite cada 2000h", "Filtros cada 500h", "An√°lisis aceite cada 1000h"] },
        { id: 2002, name: "Sistema hidr√°ulico doble bomba - p√©rdida fuerza", initial:"Movimientos lentos y cavitaci√≥n.", modelosAplicables:["Caterpillar 446/450"], alertaSeguridad:"Evitar operaci√≥n con cavitaci√≥n", severity: "medium", symptoms:["Movimientos lentos simult√°neos","Aceite espumoso"], causes:["Desbalance bombas","V√°lvulas prioridad incorrectas"], diagnosticSteps:["Medir caudal individual (95 L/min implementos, 45 L/min direcci√≥n @ 2400 RPM)","Prueba carga simult√°nea"], solution:["Balanceo bombas","Instalaci√≥n v√°lvulas prioridad", "Kit upgrade hidr√°ulico"], costoEstimado:"Var√≠a", searchTerms: "caterpillar 446 450 hidraulico doble bomba", specs: { pump_flow_implement: "95 L/min", pump_flow_steering: "45 L/min" } },
     ],
     hitachi_exc: [
        { id: 401, name: "Hydromaster Deriva Brazos", initial:"Brazos caen lentamente o pierden posici√≥n bajo carga.", modelosAplicables:["Hitachi ZX350/ZX470"], alertaSeguridad:"Riesgo de inestabilidad de implementos.", severity: "medium", symptoms:["Brazos bajan lentamente", "P√©rdida de posici√≥n bajo carga", "Sobrecalentamiento hidr√°ulico", "Movimientos no comandados"], causes:["V√°lvulas de control con leakage (desgaste de spools)", "Sellos internos da√±ados", "Acumulaci√≥n de presi√≥n residual"], diagnosticSteps:["1. Prueba de estanqueidad v√°lvulas (M√°ximo 50 bar en 5 min).", "2. Termograf√≠a v√°lvulas de control.", "3. Prueba de deriva en reposo."], solution:["Rectificado bancadas v√°lvulas", "Kit sellos alta temperatura", "Actualizaci√≥n software control hidr√°ulico"], costoEstimado:"US$ 5,000 - $15,000", searchTerms:"hitachi zx deriva brazos leakage hidromaster", codes:[] },
     ],
     doosan_exc: [
        { id: 402, name: "Motor Diesel - Problemas Inyecci√≥n", initial:"Arranque dif√≠cil en fr√≠o, humo negro.", modelosAplicables:["Doosan DX300/DX500"], severity: "medium", symptoms:["Arranque dif√≠cil fr√≠o", "Tirones al acelerar", "Humo negro intermitente", "Consumo elevado"], causes:["Inyectores fuera de calibraci√≥n", "Sensor temp/presi√≥n faulty", "Presi√≥n riel inestable", "Bomba HP"], diagnosticSteps:["1. Analizar forma onda inyectores.", "2. Probar presi√≥n riel en tiempo real.", "3. Verificaci√≥n sensores temperatura/presi√≥n."], solution:["Calibraci√≥n din√°mica inyectores", "Limpieza ultras√≥nica riel com√∫n", "Actualizaci√≥n firmware ECU"], costoEstimado:"US$ 500 - $3,000", searchTerms:"doosan dx hitachi zx inyeccion electronica falla humo negro", codes:[] },
     ],
     kawasaki_loader: [
        { id: 501, name: "Transmisi√≥n KES - Fallas Electr√≥nicas", initial:"No cambia autom√°ticamente, modo seguro, error display.", modelosAplicables:["Kawasaki 85Z/95Z"], severity: "medium", symptoms:["Display error transmisi√≥n", "No cambia autom√°ticamente", "Se queda en una marcha", "Modo seguro activado"], causes:["ECU transmisi√≥n (falla interna)", "Sensores velocidad (err√°ticos)", "Cableado/harness da√±ado", "Solenoides"], diagnosticSteps:["1. Escaneo profundo ECU transmisi√≥n.", "2. Verificaci√≥n sensores velocidad.", "3. Prueba actuaci√≥n solenoides."], solution:["Reprogramaci√≥n completa KES", "Reemplazo harness transmisi√≥n", "Kit upgrade sensores velocidad", "Reemplazo ECU"], costoEstimado:"US$ 2,000 - $8,000", searchTerms:"kawasaki 85z transmision kes falla electronica", codes:[] },
     ],
     hyundai_loader: [
        { id: 502, name: "Direcci√≥n - Bomba Orbital Ruidosa", initial:"Direcci√≥n pesada a bajas RPM, ruido bomba, fugas.", modelosAplicables:["Hyundai HL850/HL960"], severity: "low", symptoms:["Direcci√≥n pesada bajas RPM", "Ruido bomba direcci√≥n", "Fugas cr√≥nicas en cilindros", "Volante con juego excesivo"], causes:["Bomba direcci√≥n da√±ada (desgaste)", "Cilindros con fugas", "Presi√≥n baja"], diagnosticSteps:["1. Medici√≥n presi√≥n sistema (180-220 bar).", "2. An√°lisis caudal bomba direcci√≥n.", "3. Inspecci√≥n fugas cilindros."], solution:["Overhaul/reemplazo bomba direcci√≥n orbital", "Kit reparaci√≥n cilindros direcci√≥n", "Actualizaci√≥n sistema de filtrado"], costoEstimado:"US$ 1,500 - $5,000", searchTerms:"hyundai hl850 direccion pesada ruido bomba orbital", codes:[] },
     ],
     belaz_dumper: [
        { id: 601, name: "Direcci√≥n Hidr√°ulica Lenta", initial:"Direcci√≥n muy lenta, sobrecalentamiento, dif√≠cil maniobrar.", modelosAplicables:["BELAZ 7530/7560"], alertaSeguridad:"P√©rdida de control direccional.", severity: "high", symptoms:["Direcci√≥n muy lenta", "Sobrecalentamiento cr√≥nico", "Fugas en cilindros principales", "P√©rdida de control direccional"], causes:["Bomba direcci√≥n insuficiente", "Enfriamiento hidr√°ulico insuficiente", "Fugas internas en v√°lvulas/cilindros"], diagnosticSteps:["1. Medici√≥n tiempo respuesta direcci√≥n.", "2. An√°lisis t√©rmico sistema completo.", "3. Prueba de carga m√°xima."], solution:["Kit upgrade bomba direcci√≥n", "Cilindros direcci√≥n reforzados", "Sistema enfriamiento adicional"], costoEstimado:"US$ 10,000 - $30,000+", searchTerms:"belaz direccion hidraulica lenta sobrecalentamiento", codes:[] },
     ],
     komatsu_dumper: [
        { id: 602, name: "Tracci√≥n El√©ctrica AC - P√©rdida Tracci√≥n", initial:"Alarmas el√©ctricas, sobrecalentamiento motores rueda, p√©rdida tracci√≥n.", modelosAplicables:["Komatsu 860E/930E"], alertaSeguridad:"Alta tensi√≥n.", severity: "high", symptoms:["P√©rdida tracci√≥n intermitente", "Alarmas el√©ctricas m√∫ltiples", "Sobrecalentamiento motores rueda (>120¬∞C)"], causes:["M√≥dulos IGBT fatigados", "Arm√≥nicos en sistema (contaminaci√≥n)", "Falla generador/inversor", "Cableado"], diagnosticSteps:["1. An√°lisis arm√≥nicos sistema el√©ctrico.", "2. Termograf√≠a componentes potencia.", "3. Prueba aislamiento motores/generador."], solution:["Reemplazo m√≥dulos IGBT", "Recalibraci√≥n tracci√≥n", "Reparaci√≥n/reemplazo generador/inversor"], costoEstimado:"US$ 10,000 (IGBT) - $400,000+ (Generador)", searchTerms:"komatsu 930e traccion electrica falla igbt", codes:[] },
     ],
    diagnostico: [
        { id: 8001, name: "An√°lisis de Vibraciones (Rodamientos/Engranajes)", initial:"Detecci√≥n de fatiga/desbalance/desalineaci√≥n.", modelosAplicables:["Diagn√≥stico Avanzado"], symptoms:["Aumento velocidad vibratoria RMS", "Bandas laterales engranajes", "Frecuencias caracter√≠sticas rodamientos (BPFO, BPFI)"], causes:["Desbalanceo", "Desalineaci√≥n", "Fatiga rodamientos", "Desgaste engranajes"], diagnosticSteps:["1. Adquisici√≥n aceler√≥metros 10kHz.", "2. An√°lisis espectral (FFT).", "3. Tendencias de velocidad/aceleraci√≥n."], solution:["Balanceo din√°mico", "Alineaci√≥n l√°ser", "Reemplazo rodamientos/engranajes"], costoEstimado:"N/A (Metodolog√≠a)", searchTerms:"analisis vibraciones rodamientos engranajes", codes:[], diagnosticTechnique:["Aceler√≥metros triaxiales, muestreo >=10kHz, an√°lisis espectral.", "L√≠mites: < 2.8 mm/s - Bueno; > 7.1 mm/s - No satisfactorio (ISO 10816-3).", "Frecuencias t√≠picas: BPFO, BPFI, FTF, BSF. Consultar tablas de rodamientos."], specs: { iso:"ISO 10816-3", freq_sampling: ">= 10 kHz" } },
        { id: 8002, name: "Termograf√≠a Infrarroja (Hotspots)", initial:"Detecci√≥n de sobrecalentamiento en componentes.", modelosAplicables:["Diagn√≥stico Avanzado"], symptoms:["Puntos calientes (Hotspots) detectables IR"], causes:["Conexiones el√©ctricas flojas", "Desbalanceo de fases", "Falla incipiente en rodamientos", "V√°lvulas hidr√°ulicas obstruidas"], diagnosticSteps:["1. Escaneo termografico (comparar con baseline).", "2. Medici√≥n de gradientes de temperatura.", "3. Inspecci√≥n visual del componente."], solution:["Apretar conexiones", "Equilibrar fases", "Reemplazar rodamientos", "Limpieza/Reemplazo v√°lvulas"], costoEstimado:"N/A (Metodolog√≠a)", searchTerms:"termografia infrarroja diagnostico hotspots", codes:[], diagnosticTechnique:["Diferencia de temperatura > 15¬∞C respecto a componentes similares o baseline es cr√≠tica.", "Usar an√°lisis termogr√°fico comparativo (Delta T) y absoluto."] },
        { id: 9001, name: "An√°lisis de Aceite (Tribolog√≠a)", initial:"Part√≠culas de desgaste elevadas, contaminaci√≥n, degradaci√≥n.", modelosAplicables:["Diagn√≥stico Avanzado"], symptoms:["Aumento Fe, Si, Al, Cr en ppm", "Viscosidad fuera de rango", "Alto N√∫mero √Åcido (TAN)", "Presencia Agua/Combustible"], causes:["Desgaste rodamientos/engranajes", "Contaminaci√≥n abrasiva (Si/Al)", "Contaminaci√≥n por agua/combustible", "Oxidaci√≥n/degradaci√≥n aditivos"], diagnosticSteps:["1. Espectrometr√≠a de emisi√≥n at√≥mica (ICP/OES).", "2. Viscosidad cinem√°tica (40¬∞C/100¬∞C).", "3. N√∫mero √Åcido Total (TAN) / N√∫mero B√°sico Total (TBN).", "4. Ferrograf√≠a Anal√≠tica (morfolog√≠a part√≠culas).", "5. Conteo de part√≠culas (ISO 4406)."], solution:["Filtrado avanzado (ri√±√≥n)", "Cambio aceite", "Investigaci√≥n origen part√≠culas", "Reemplazo filtros", "Reparaci√≥n sellos"], costoEstimado:"N/A (Metodolog√≠a)", searchTerms:"analisis aceite ppm desgaste contaminacion ferrografia", codes:[], diagnosticTechnique:["L√≠mites cr√≠ticos (ppm) var√≠an por compartimento: Fe > 50-200 (motor), Si > 20 (alerta contaminaci√≥n).", "Clasificaci√≥n ISO 4406 limpieza (Objetivo: 18/16/13 o menor para hidr√°ulico).", "Verificar si la diluci√≥n por combustible es mayor al 2%."] },
        { id: 10001, name: "Alineaci√≥n L√°ser de Ejes", initial:"Desalineaci√≥n provoca vibraciones y desgaste acelerado.", modelosAplicables:["Diagn√≥stico Avanzado"], symptoms:["Vibraci√≥n elevada (1x, 2x RPM)", "Fugas en sellos", "Sobrecalentamiento rodamientos", "Falla prematura acoplamientos"], causes:["Desalineaci√≥n paralela/angular", "Asentamiento base", "Expansi√≥n t√©rmica"], diagnosticSteps:["Medici√≥n tolerancia (< 0.05mm/m)", "Compensaci√≥n t√©rmica (calcular crecimiento)", "Verificaci√≥n 'soft foot' (<0.05mm)"], solution:["Alineaci√≥n l√°ser precisa usando shims", "Documentar ajustes", "Revisi√≥n peri√≥dica (cada 2000h)"], costoEstimado:"N/A (Procedimiento)", searchTerms:"alineacion laser ejes vibracion desgaste soft foot", codes:[], diagnosticTechnique:["Usar equipo l√°ser de doble haz.", "Compensar crecimiento t√©rmico: ŒîL = Œ± * L * ŒîT."] },
        { id: 11001, name: "Modelos Predictivos - Machine Learning", initial:"Predicci√≥n de fallas utilizando datos de sensores y M/L.", modelosAplicables:["Diagn√≥stico Avanzado"], symptoms:["Tendencias de degradaci√≥n detectadas", "Alertas predictivas generadas", "Estimaci√≥n RUL (Remaining Useful Life)"], causes:["No aplica (metodolog√≠a)"], diagnosticSteps:["1. Recolectar hist√≥rico mantenimiento y sensores (vibraci√≥n, temp, presi√≥n, aceite).", "2. Preprocesar datos (limpieza, normalizaci√≥n, feature engineering).", "3. Entrenar modelos (Random Forest, LSTM, SVM, Autoencoders).", "4. Validar (cross-validation, m√©tricas F1/AUC).", "5. Desplegar modelo y monitorear rendimiento."], solution:["Implementar alertas tempranas en CMMS", "Optimizar planificaci√≥n mantenimiento CBM", "Generar recomendaciones acci√≥n"], costoEstimado:"N/A (Metodolog√≠a)", searchTerms:"mantenimiento predictivo machine learning RUL", codes:[], diagnosticAdvanced: { description: "Algoritmos comunes y su aplicaci√≥n:", code: `Random Forest: Clasificaci√≥n multiclase de tipos de falla.\nLSTM: Predicci√≥n RUL basado en series temporales.\nAutoencoder Variacional: Detecci√≥n de anomal√≠as en operaci√≥n normal.`} },
        { id: 10002, name: "Termodin√°mica Aplicada a Motores", initial:"An√°lisis de rendimiento y diagn√≥stico por par√°metros t√©rmicos.", modelosAplicables:["Diagn√≥stico Avanzado"], diagnosticTechnique:["Medir Temp. escape (pre/post-turbo), eficiencia t√©rmica, balance t√©rmico.", "Temp. escape >700¬∞C indica inyecci√≥n tard√≠a/baja compresi√≥n.", "ŒîT cooling >15¬∞C indica restricci√≥n flujo/bomba d√©bil."], specs: {efficiency_target: "38-42%"} },
        { id: 10003, name: "An√°lisis Avanzado de Cavitaci√≥n", initial:"Detecci√≥n y diagn√≥stico de cavitaci√≥n en sistemas hidr√°ulicos.", modelosAplicables:["Diagn√≥stico Avanzado"], diagnosticTechnique:["Calcular NPSH disponible vs requerido (NPSH_disp > NPSH_req + 0.5m).", "Analizar espectro de vibraci√≥n: Frecuencias >10kHz (incipiente), bandas laterales (desarrollada).", "Usar transductores de presi√≥n din√°mica y aceler√≥metros HF."], specs: {freq_range: "0-100kHz"} },
    ]
    // ... (El resto de la base de datos completa ir√≠a aqu√≠) ...
};

// --- PLANTILLAS PARA ESCENARIOS GENERALES ---
// (Estas plantillas se usan si la b√∫squeda no encuentra nada en la DB local Y no se llama a la API)
const generalScenarioTemplates = {
    "motor_con_agua": (machineName) => ({
        id: `gen_agua_${Date.now()}`, _sourceKey: "diagnostico", name: `Ingreso de Agua al Motor (${machineName})`,
        initial: `Detectado posible ingreso de agua (refrigerante o externa) al sistema de combusti√≥n o lubricaci√≥n.`,
        modelosAplicables: [machineName || "Maquinaria General"],
        alertaSeguridad: "‚ö†Ô∏è ¬°NO INTENTE ARRANCAR EL MOTOR! Riesgo de da√±o catastr√≥fico (hydro lock). Detener inmediatamente si estaba en marcha.",
        severity: "high",
        symptoms: ["Humo blanco excesivo y denso por el escape (vapor de agua).", "El motor no gira o se bloquea al intentar arrancar (hydro lock).", "Nivel de refrigerante bajo sin fugas externas visibles.", "Nivel de aceite sube y/o aceite con apariencia lechosa/gris√°cea.", "Sobrecalentamiento del motor.", "Burbujas en el radiador."],
        causes: ["Falla de la junta de culata (empaquetadura).", "Culata (cabeza del motor) fisurada o deformada.", "Bloque del motor fisurado.", "Falla del enfriador de aceite (si es enfriado por agua).", "Falla del enfriador de EGR (si es enfriado por agua).", "Ingreso de agua por la admisi√≥n."],
        diagnosticSteps: ["1. **¬°NO ARRANCAR!** Verificar nivel y apariencia del aceite (varilla). ¬øLechoso?", "2. Verificar nivel y apariencia del refrigerante. ¬øAceitoso?", "3. Quitar inyectores (diesel) y girar el motor manualmente para ver si expulsa l√≠quido por los cilindros.", "4. Realizar prueba de presi√≥n al sistema de enfriamiento.", "5. Realizar prueba de fugas de cilindros."],
        solution: ["Drenar TODO el aceite y refrigerante contaminados.", "Identificar y reparar la causa ra√≠z (reemplazo de junta, reparaci√≥n/reemplazo de culata/bloque, reemplazo de enfriador).", "Limpiar internamente el motor.", "Reemplazar filtros de aceite.", "Llenar con fluidos nuevos y purgar sistema."],
        costoEstimado: "US$ 500 (junta simple) - US$ 10,000+ (motor nuevo)",
        searchTerms: "motor agua hydro lock junta culata aceite lechoso humo blanco",
        prevention: ["Mantenimiento preventivo del sistema de enfriamiento", "Controlar temperatura de operaci√≥n", "Evitar sobrecalentamiento", "Inspeccionar niveles regularmente."],
        _isGenerated: true
    }),
    // ... (Aqu√≠ ir√≠an las otras plantillas: motor_sin_aceite, sin_refrigerante, poco_aire) ...
};

// --- L√ìGICA DE LA INTERFAZ (v19.4) ---

// DOM Elements
const sidebar = document.getElementById('sidebar');
const typeFilter = document.getElementById('typeFilter');
const subsystemFilter = document.getElementById('subsystemFilter');
const globalSearchInputSidebar = document.getElementById('globalSearchInputSidebar');
const globalSearchInputHeader = document.getElementById('globalSearchInputHeader');
const cardsGrid = document.getElementById('cardsGrid');
const totalCount = document.getElementById('totalCount');
const foundCount = document.getElementById('foundCount');
const uniqueModels = document.getElementById('uniqueModels');
const diagnosisPanelOverlay = document.getElementById('diagnosisPanelOverlay');
const diagnosisPanel = document.getElementById('diagnosisPanel');
const diagTitle = document.getElementById('diagTitle');
const diagContent = document.getElementById('diagContent');
const toggleAtacama = document.getElementById('toggleAtacama');
const currentModeDisplay = document.getElementById('currentModeDisplay');
const loadedSourceDisplay = document.getElementById('loadedSourceDisplay');
const btnExport = document.getElementById('btnExport');
const reviewBeforeExport = document.getElementById('reviewBeforeExport');
const btnShowKPIs = document.getElementById('btnShowKPIs');
const btnShowDiagTech = document.getElementById('btnShowDiagTech');
const btnResetFilters = document.getElementById('btnResetFilters');
const btnShowAll = document.getElementById('btnShowAll');
const closeDiagnosisPanelBtn = document.getElementById('closeDiagnosisPanelBtn');
const copyDiagnosisBtn = document.getElementById('copyDiagnosisBtn');
const exportDiagnosisBtn = document.getElementById('exportDiagnosisBtn');
const printDiagnosisBtn = document.getElementById('printDiagnosisBtn');
const btnOpenGoogleDiagModal = document.getElementById('btnOpenGoogleDiagModal');
const loadingCardTemplate = document.getElementById('loadingCardTemplate');

let currentResults = []; 
let currentDisplayedItem = null;
let allItemsFlat = []; 
let isAILoading = false;
let currentSearchController = null; // Para abortar peticiones fetch

// --- Inicializaci√≥n ---
(function init() {
    populateTypeFilter();
    allItemsFlat = flattenData(allFailuresData);
    computeTotals(allItemsFlat); 
    renderInitialMessage();
    setupEventListeners();
})();

// --- Funciones de Datos ---
function flattenData(data) {
    const flatList = [];
    for (const key in data) {
        if (Array.isArray(data[key])) {
            data[key].forEach(item => {
                if (item && typeof item === 'object') {
                    flatList.push({ ...item, _sourceKey: key });
                }
            });
        }
    }
    return flatList;
}

function populateTypeFilter() {
  const select = typeFilter;
  select.innerHTML = '<option value="">-- Tipo de Maquinaria --</option>';
  const sortedTypes = Object.keys(machineTypes).sort((a, b) => machineTypes[a].name.localeCompare(machineTypes[b].name));
  sortedTypes.forEach(key => {
    const opt = document.createElement('option');
    opt.value = key;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = machineTypes[key].name;
    opt.textContent = tempDiv.textContent || tempDiv.innerText || machineTypes[key].name;
    select.appendChild(opt);
  });
}

function computeTotals(items) {
  const total = items.length;
  const models = new Set();
  items.forEach(it => {
      if (it.modelosAplicables && Array.isArray(it.modelosAplicables)) {
          it.modelosAplicables.forEach(m => models.add(m));
      }
  });
  totalCount.textContent = `${total}`;
  // Contadores 'foundCount' y 'uniqueModels' se actualizan en searchAndRender
  foundCount.textContent = '...';
  uniqueModels.textContent = '...';
}

// --- L√≥gica de B√∫squeda y Filtrado (MODIFICADA para IA) ---
async function searchAndRender() {
  if (isAILoading) {
      currentSearchController?.abort(); // Abortar b√∫squeda anterior si hay una nueva
  }

  const qSidebar = (globalSearchInputSidebar.value || '').trim().toLowerCase();
  const qHeader = (globalSearchInputHeader.value || '').trim().toLowerCase();
  const q = qSidebar || qHeader;
  const typeKey = typeFilter.value;
  const subsystem = subsystemFilter.value;

  let results = [];
  let generatedResult = null;

  // 1. Filtrar datos existentes
  results = allItemsFlat.filter(item => {
    if (typeKey) {
         let typeMatch = item._sourceKey === typeKey;
         if (!typeMatch && machineTypes[typeKey]) {
             const typeNameLower = machineTypes[typeKey].name.toLowerCase();
             const itemTextLower = JSON.stringify(item).toLowerCase();
             if (item._sourceKey === 'diagnostico' || itemTextLower.includes(typeNameLower)) {
                 typeMatch = true;
             }
         }
        if (!typeMatch) return false;
    }
    if (subsystem) {
        const text = (item.name + ' ' + (item.initial || '') + ' ' + (item.solution || '') + ' ' + (item.causes || []).join(' ') + ' ' + (item.diagnosticSteps || []).join(' ') + ' ' + (item.searchTerms || '')).toLowerCase();
        const subsMap = {
          inyeccion: ['inyector','inject','common rail','combustible','diesel','injector', 'hp', 'dpf', 'egr'],
          hidraulico: ['hidraul','hydraulic','valvul','bomb','caudal','cavitacion','presi√≥n','aceite h', 'cilindro h', 'manguera h', 'likufic', 'hydromaster', 'eppr', 'hst'],
          electrico: ['igbt','electr','tracci','motor el√©ctrico','el√©ctrico','alternator', 'sensor', 'ecu', 'cableado', 'bateria', 'arn√©s', 'bus can', 'tcm', 'controlador', 'plc'],
          transmision: ['transmis','torque','convertedor','clutch','atf','gear', 'powershift', 'hst', 'diferencial', 'mando final', 'eje', 'planetario', 'torqflow', 'kes', 'optishift', 'ecpc', '6r80', '10r80', 'zf 8hp', 'dsg'],
          sistemas_aux: ['lubric','filtro','enfriador', 'radiador', 'scr', 'adblue', 'escape', 'admision', 'suspension', 'neumatico', 'aire', 'compresor', 'vacio', 'egr', 'refrigerante', 'cooling'],
          motor: ['motor', 'diesel', 'gasolina', 'combustion', 'cilindro', 'pist√≥n', 'biela', 'cig√ºe√±al', 'culata', 'v√°lvula', 'turbo', 'vgt', 'intercooler', 'acert', 'ecoboost', 'duramax', 'ecomax', 'c175', 'ssda18v170', '16v4000', 'c32', 'sda16v160', 'd9812', 'qsk60', 'c9.3', 'c18', 'qsl9', 'om473', 'd13k', 'dc13', 'c13', '4045', 'b3.3', 'bf4m2012'],
          chasis: ['chasis', 'bastidor', 'estructura', 'kingpost', 'articulacion', 'brazo', 'balde', 'hoja', 'ripper', 'pluma', 'tren rodaje', 'corona giro', 'tambor', 'cable', 'polea', 'empalme', 'implemento'],
          frenos: ['freno', 'disco', 'pastilla', 'caliper', 'retarder', 'neum√°tico', 'aire', 'abs'],
          direccion: ['direccion', 'volante', 'orbital', 'hidrost√°tica', 'cilindro d', 'bomba d'],
          tren_rodaje: ['tren rodaje', 'oruga', 'cadena', 'rodillo', 'sprocket', 'zapata', 'rueda gu√≠a', 'tensor', 'neum√°tico', 'llanta'],
          diagnostico: ['vibracion', 'aceite', 'termografia', 'ultrasonido', 'laser', 'cfd', 'fea', 'ml']
        };
        const keywords = subsMap[subsystem] || [];
        if (!keywords.some(k => text.includes(k))) return false;
    }
    if (q) {
        const itemString = JSON.stringify(item).toLowerCase();
        // Usar AND impl√≠cito para t√©rminos de b√∫squeda
        const terms = q.split(' ').filter(term => term.length > 1);
        if (terms.length > 0 && !terms.every(term => itemString.includes(term))) {
            return false;
        }
    }
    return true;
  });

  // 2. Si no hay resultados locales, intentar con plantillas de escenarios generales
  if (results.length === 0 && q.length > 3 && typeKey) {
      generatedResult = handleGeneralScenarioQuery(q, typeKey);
  }

  // 3. Si A√öN no hay resultados Y hay una b√∫squeda, llamar a la API
  if (results.length === 0 && !generatedResult && q.length > 5) { // 5 caracteres m√≠nimo
      isAILoading = true;
      currentSearchController = new AbortController(); // Preparar para abortar si es necesario
      renderLoadingCard(q);
      
      try {
          const aiResponse = await askGeminiApi(q, typeKey, currentSearchController.signal);
          generatedResult = parseGeminiResponseToItem(aiResponse, q, typeKey);
      } catch (error) {
          if (error.name === 'AbortError') {
              console.log("B√∫squeda IA abortada.");
              return; // No hacer nada, la nueva b√∫squeda tomar√° el control
          }
          console.error("Error llamando a la API de Gemini:", error);
          generatedResult = {
              _isGenerated: true, _sourceKey: "diagnostico", id: `err_${Date.now()}`,
              name: `Error de API: ${q}`,
              initial: "No se pudo contactar al asistente de IA.",
              alertaSeguridad: `Hubo un error al intentar generar una respuesta. ${error.message}`,
              severity: "high",
              symptoms: [], causes: [], diagnosticSteps: [], solution: ["Verifica tu conexi√≥n a internet.", "Verifica que tu API en Vercel est√© funcionando.", "Verifica la consola de Vercel para ver los logs del backend.", "Intenta la b√∫squeda de nuevo."]
          };
      }
      
      isAILoading = false;
      currentSearchController = null;
  }

  // 4. Renderizar
  currentResults = results;
  
  if (generatedResult) {
      renderCards([generatedResult]);
      foundCount.textContent = `1`;
      uniqueModels.textContent = `1`; 
  } else {
      renderCards(results);
      foundCount.textContent = `${results.length}`;
      const filteredModels = new Set();
      results.forEach(it => {
          if (it.modelosAplicables && Array.isArray(it.modelosAplicables)) {
              it.modelosAplicables.forEach(m => filteredModels.add(m));
          }
      });
      uniqueModels.textContent = `${filteredModels.size}`;
  }
}

// --- L√≥gica de Renderizado ---
function renderInitialMessage() {
    cardsGrid.innerHTML = '<div class="card"><h4>Bienvenido a HeavyDiag</h4><p class="muted">Usa los filtros o la barra de b√∫squeda para encontrar informaci√≥n sobre fallas, diagn√≥sticos o preguntar sobre escenarios comunes (ej: "motor con agua" con un tipo de m√°quina seleccionado).</p></div>';
    foundCount.textContent = `0`;
    uniqueModels.textContent = `0`;
}

function renderLoadingCard(query) {
    cardsGrid.innerHTML = '';
    const template = loadingCardTemplate.content.cloneNode(true);
    template.querySelector(".loading-query").textContent = query;
    cardsGrid.appendChild(template);
    foundCount.textContent = `1`;
    uniqueModels.textContent = `0`;
}

function renderCards(results) {
  cardsGrid.innerHTML = '';
  if (!results.length) {
    const qSidebar = globalSearchInputSidebar.value.trim();
    const qHeader = globalSearchInputHeader.value.trim();
    const type = typeFilter.value;
    const subsystem = subsystemFilter.value;
    if (!qSidebar && !qHeader && !type && !subsystem) {
        renderInitialMessage();
    } else {
        cardsGrid.innerHTML = '<div class="card"><h4>No se encontraron coincidencias</h4><p class="muted">Prueba con otras palabras clave o limpia los filtros. Si es una pregunta compleja, la IA intentar√° responder.</p></div>';
    }
    return;
  }
  
  const resultsToDisplay = results.slice(0, 500); 
  
  resultsToDisplay.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const severityClass = getSeverityClass(item.severity || item.alertaSeguridad);
    if (severityClass) { card.classList.add(severityClass); }
    const machineKey = item._sourceKey; 
    const machineInfo = machineTypes[machineKey];
    const icon = item._isGenerated ? '<i class="fas fa-robot"></i>' : (machineInfo?.icon || '<i class="fas fa-question-circle"></i>');
    
    card.innerHTML = `
      <h4>${renderIcon(icon)} ${item.name || 'Entrada sin nombre'}</h4>
      <p class="muted">${item.initial || 'Descripci√≥n breve no disponible.'}</p>
      <div class="tags">
        ${item._sourceKey ? `<span class="tag">${item._sourceKey.replace(/_/g, ' ').toUpperCase()}</span>` : ''}
        ${item._isGenerated ? '<span class="tag" style="background: var(--advan-color); color: white;">IA GENERADO</span>' : ''}
        ${item.modelosAplicables ? item.modelosAplicables.slice(0, 1).map(m => `<span class="tag">${m}</span>`).join('') : ''}
        ${item.codes && item.codes.length > 0 ? `<span class="tag code-tag"><i class="fas fa-code"></i> ${item.codes[0]}</span>` : ''}
      </div>
    `;
    card.onclick = () => showDiagnosis(item);
    cardsGrid.appendChild(card);
  });
}

function getSeverityClass(severity) {
    if (!severity) return '';
    const lowerSeverity = String(severity).toLowerCase();
    if (lowerSeverity.includes('riesgo cr√≠tico') || lowerSeverity.includes('urgente') || lowerSeverity === 'high' || lowerSeverity === 'error' || lowerSeverity === 'failed') { return 'severity-high'; }
    else if (lowerSeverity.includes('riesgo') || lowerSeverity === 'medium' || lowerSeverity === 'warning') { return 'severity-warning'; }
    else if (lowerSeverity === 'low') { return 'severity-low'; }
    else if (lowerSeverity === 'passed' || lowerSeverity === 'success') { return 'severity-success'; }
    return '';
}

// --- Mostrar Panel de Diagn√≥stico ---
function showDiagnosis(item) {
    if (!item || typeof item !== 'object') return;
    currentDisplayedItem = item; 
    
    const icon = item._isGenerated ? '<i class="fas fa-robot"></i>' : (machineTypes[item._sourceKey]?.icon || '?');
    diagTitle.innerHTML = `${renderIcon(icon)} ${item.name || 'Detalle de Falla'} ${item._isGenerated ? '<span class="chip" style="font-size: 0.8rem; background: var(--advan-color); color: white; margin-left: 10px;">INFO GENERADA</span>' : ''}`;
    
    diagContent.innerHTML = `
        ${(item.modelosAplicables && Array.isArray(item.modelosAplicables)) ?
        `<p class="model-info" style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; text-align: right;">${item._isGenerated ? 'Contexto:' : 'Modelos:'} ${item.modelosAplicables.join(', ')}</p>`: ''}
        <div class="info-card"><h4><i class="fas fa-eye"></i> S√≠ntomas</h4>${renderList(item.symptoms)}<p style="margin-top:10px;"><strong>Contexto Inicial:</strong> ${item.initial || 'N/A'}</p></div>
        ${item.alertaSeguridad ? `<div class="info-card alert-safety"><h4><i class="fas fa-triangle-exclamation"></i> Alerta Seguridad</h4><p>${item.alertaSeguridad || 'N/A'}</p></div>` : ''}
        <div class="info-card"><h4><i class="fas fa-project-diagram"></i> Causas Probables</h4>${renderList(item.causes)}</div>
        <div class="info-card"><h4><i class="fas fa-stethoscope"></i> Pasos de Diagn√≥stico</h4>${renderList(item.diagnosticSteps, 'ol')}</div>
        ${renderAdvanced(item.diagnosticAdvanced || item.diagnosticTechnique || item.diagnosticStepsAdvanced)}
        <div class="info-card"><h4><i class="fas fa-wrench"></i> Soluciones Recomendadas</h4>${renderList(item.solution)}</div>
        ${renderAdvanced(item.solutionAdvanced)}
        <div class="info-card gestion-card"><h4><i class="fas fa-tasks"></i> Gesti√≥n (Estimados)</h4><p><strong>Costo Estimado:</strong> ${item.costoEstimado || 'Variable'}</p>${item.tiempoDowntime ? `<p><strong>Tiempo Inactividad (Downtime):</strong> ${item.tiempoDowntime}</p>` : ''}</div>
        ${renderSpecs(item.specs)}
        ${renderCodes(item.codes)}
        ${renderAtacama(item.atacamaNotes)}
        ${item.datoIngeniero || item.prevention ? `<div class="info-card alert-engineer"><h4><i class="fas ${item.prevention ? 'fa-shield-alt' : 'fa-lightbulb'}"></i> ${item.prevention ? 'Prevenci√≥n' : 'Dato T√©cnico'}</h4>${item.datoIngeniero ? `<p>${item.datoIngeniero}</p>` : ''}${item.prevention ? renderList(item.prevention) : ''}</div>` : ''}
    `;
    
    diagContent.querySelectorAll('.btn-ai-explain').forEach(btn => {
        btn.addEventListener('click', handleExplainCodeClick);
    });

    const searchTerm = (typeof item.searchTerms === 'string' ? item.searchTerms : item.name) || '';
    const q = encodeURIComponent(searchTerm);
    let modelName = '';
     if (item.modelosAplicables && item.modelosAplicables.length > 0) { modelName = item.modelosAplicables[0].split(' ')[0]; }
     else if (machineTypes[item._sourceKey]) { modelName = machineTypes[item._sourceKey].name.split(' ')[0]; }
    btnOpenGoogleDiagModal.href = `https://www.google.com/search?q=${q}+${encodeURIComponent(modelName)}`;

    diagnosisPanelOverlay.style.display = 'flex'; 
    if (toggleAtacama.checked) { diagnosisPanel.classList.add('show-atacama'); }
    else { diagnosisPanel.classList.remove('show-atacama'); }
}

// Cerrar Panel
closeDiagnosisPanelBtn.onclick = () => { diagnosisPanelOverlay.style.display = 'none'; currentDisplayedItem = null; };
diagnosisPanelOverlay.onclick = (e) => { if (e.target === diagnosisPanelOverlay) { diagnosisPanelOverlay.style.display = 'none'; currentDisplayedItem = null; } };

// --- Funciones Auxiliares UI ---
const renderList = (items, type = 'ul') => {
    if (!items || (Array.isArray(items) && items.length === 0)) return '<p>Informaci√≥n no disponible.</p>';
    if (typeof items === 'string') return `<p>${items}</p>`;
    if (Array.isArray(items)) {
        const listItems = items.filter(item => item != null && String(item).trim() !== '').map(item => `<li>${String(item)}</li>`).join('');
        if (!listItems) return '<p>Informaci√≥n no disponible.</p>';
        return type === 'ol' ? `<ol>${listItems}</ol>` : `<ul>${listItems}</ul>`;
    }
    return '<p>Formato de datos no reconocido.</p>';
};
const renderCodes = (codes) => {
    if (!Array.isArray(codes) || codes.length === 0) return '';
    const codeItems = codes.filter(c => c != null && String(c).trim() !== '').map(c => `<code>${String(c)}</code>`).join(' ');
     if (!codeItems) return '';
    return `<div class="info-card codes-list"><h4><i class="fas fa-laptop-code"></i> C√≥digos Error Comunes</h4><p>${codeItems}</p></div>`;
};
const renderAdvanced = (items) => {
    if (!items) return '';
    let content = '';
    let codeToExplain = '';
    if (typeof items === 'string') { content = `<p>${items}</p>`; codeToExplain = items; }
    else if (Array.isArray(items) && items.length > 0) { content = renderList(items, 'ol'); codeToExplain = items.join('\n'); }
    else if (typeof items === 'object' && items !== null && items.code !== undefined) { content = `${items.description ? `<p>${items.description}</p>` : ''}<pre><code>${items.code}</code></pre>`; codeToExplain = items.code; }
    else { return ''; }
    const aiButton = `<button class="btn-ai-explain" data-code="${encodeURIComponent(codeToExplain)}"><i class="fas fa-robot"></i> Explicar</button>`;
    return `<div class="info-card advanced-card">${aiButton}<h4><i class="fas fa-flask-vial"></i> Diagn√≥stico Avanzado / T√©cnico</h4>${content}</div>`;
};
const renderSpecs = (specs) => {
     if (!specs) return '';
     let content = '';
     if(typeof specs === 'string') { content = `<p>${specs}</p>`; }
     else if (Array.isArray(specs) && specs.length > 0) { content = renderList(specs); }
     else if (typeof specs === 'object' && specs !== null && Object.keys(specs).length > 0) {
         content = '<ul>';
         for (const key in specs) {
             const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).replace(/_/g, ' ');
             content += `<li><strong>${formattedKey}:</strong> ${specs[key]}</li>`;
         }
         content += '</ul>';
     }
     if (!content || content === '<ul></ul>') return '';
     return `<div class="info-card specs-card"><h4><i class="fas fa-ruler-combined"></i> Especificaciones T√©cnicas</h4>${content}</div>`;
};
const renderAtacama = (notes) => {
    if (!notes) return '';
    let content = '';
     if(typeof notes === 'string') { content = `<p>${notes}</p>`; }
     else if (Array.isArray(notes) && notes.length > 0) { content = renderList(notes); }
     else if (typeof notes === 'object' && notes !== null && Object.keys(notes).length > 0) {
         content = '<ul>';
         for (const key in notes) {
             const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).replace(/_/g, ' ');
             content += `<li><strong>${formattedKey}:</strong> ${notes[key]}</li>`;
         }
         content += '</ul>';
     }
     if (!content || content === '<ul></ul>') return '';
     return `<div class="info-card atacama-note"><h4><i class="fas fa-mountain-sun"></i> Notas Espec√≠ficas Atacama</h4>${content}</div>`;
}
function renderIcon(iconHtmlOrEmoji) {
    if (typeof iconHtmlOrEmoji === 'string' && iconHtmlOrEmoji.startsWith('<i')) { return `<span class="icon">${iconHtmlOrEmoji}</span>`; }
    return `<span class="icon">${iconHtmlOrEmoji || '‚ùì'}</span>`;
}

// --- Event Listeners ---
function setupEventListeners() {
    globalSearchInputSidebar.addEventListener('input', (e) => { globalSearchInputHeader.value = e.target.value; searchAndRender(); });
    globalSearchInputHeader.addEventListener('input', (e) => { globalSearchInputSidebar.value = e.target.value; searchAndRender(); });
    globalSearchInputSidebar.addEventListener('keydown', handleSearchEnter);
    globalSearchInputHeader.addEventListener('keydown', handleSearchEnter);
    typeFilter.addEventListener('change', searchAndRender);
    subsystemFilter.addEventListener('change', searchAndRender);
    btnResetFilters.addEventListener('click', () => { globalSearchInputSidebar.value = ''; globalSearchInputHeader.value = ''; typeFilter.value = ''; subsystemFilter.value = ''; renderInitialMessage(); computeTotals(allItemsFlat); });
     btnShowAll.addEventListener('click', () => { globalSearchInputSidebar.value = ''; globalSearchInputHeader.value = ''; typeFilter.value = ''; subsystemFilter.value = ''; currentResults = allItemsFlat; renderCards(allItemsFlat.slice(0, 500)); foundCount.textContent = `${allItemsFlat.length}`; computeTotals(allItemsFlat); });
    toggleAtacama.addEventListener('change', () => {
        const showAtacama = toggleAtacama.checked;
        currentModeDisplay.textContent = showAtacama ? 'Modo: Atacama' : 'Modo: Normal';
        document.body.classList.toggle('show-atacama', showAtacama);
        if (diagnosisPanelOverlay.style.display === 'flex' && currentDisplayedItem) {
            diagnosisPanel.classList.toggle('show-atacama', showAtacama);
        }
    });
    btnExport.addEventListener('click', exportResults);
    btnShowKPIs.addEventListener('click', showKPIPopup);
    btnShowDiagTech.addEventListener('click', showTechPopup);
    copyDiagnosisBtn.onclick = copyDiagnosisToClipboard;
    exportDiagnosisBtn.onclick = exportCurrentDiagnosis;
    printDiagnosisBtn.onclick = printCurrentDiagnosis;
}

function handleSearchEnter(event) {
  if (event.key === 'Enter') { event.preventDefault(); searchAndRender(); }
}

// --- L√≥gica de IA (NUEVO) ---

// Plantillas (ya no se usan si la API est√° activa, pero se dejan como fallback)
function handleGeneralScenarioQuery(query, machineTypeKey) {
    const machineTypeName = machineTypes[machineTypeKey]?.name || machineTypeKey || "Maquinaria";
    let scenarioKey = null;
    if (query.includes('agua') && query.includes('motor')) scenarioKey = "motor_con_agua";
    else if ((query.includes('sin') || query.includes('bajo')) && query.includes('aceite')) scenarioKey = "motor_sin_aceite";
    else if ((query.includes('sin') || query.includes('bajo')) && (query.includes('refrigerante') || query.includes('coolant'))) scenarioKey = "sin_refrigerante";
    else if ((query.includes('poco') || query.includes('falta') || query.includes('insuficiente')) && query.includes('aire')) scenarioKey = "poco_aire";
    
    // Si queremos priorizar la API, comentamos esta l√≠nea:
    // if (scenarioKey && generalScenarioTemplates[scenarioKey]) {
    //     return { ...generalScenarioTemplates[scenarioKey](machineTypeName), _isGenerated: true, _sourceKey: machineTypeKey };
    // }
    return null; // Forzar que pase a la API
}

async function askGeminiApi(prompt, context, signal) {
    // IMPORTANTE: Esta es la URL relativa a tu API en Vercel.
    const API_ENDPOINT = '/api/askGemini'; 
    
    // Usar un nombre de m√°quina m√°s descriptivo para el contexto
    const contextName = machineTypes[context]?.name || context || "maquinaria general";

    const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        signal: signal, // Pasar la se√±al de AbortController
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ prompt, context: contextName }), // Env√≠a el prompt y el contexto
    });

    if (!response.ok) {
        const errorData = await response.json();
        // Construir un mensaje de error m√°s claro
        throw new Error(errorData.details || errorData.error || `Error de API: ${response.statusText}`);
    }

    const data = await response.json();
    return data.text; // Asumiendo que tu API Vercel devuelve { text: "..." }
}

/**
 * Parsea una respuesta de texto de Gemini a un objeto de Falla.
 * Actualizado para manejar Markdown (ej. **S√≠ntomas:**)
 */
function parseGeminiResponseToItem(textResponse, query, machineTypeKey) {
    const machineName = machineTypes[machineTypeKey]?.name || machineTypeKey;
    const item = {
        _isGenerated: true, _sourceKey: "diagnostico", id: `gen_ai_${Date.now()}`,
        name: `Respuesta IA: ${query} (${machineName})`,
        initial: `Respuesta generada por IA para la consulta: "${query}" en el contexto de ${machineName}.`,
        modelosAplicables: [machineName],
        severity: "info",
        symptoms: [], causes: [], diagnosticSteps: [], solution: [],
        alertaSeguridad: "Esta es una respuesta generada por IA. Verifica siempre la informaci√≥n con manuales oficiales antes de realizar reparaciones.",
        prevention: []
    };

    try {
        const sections = {
            "**s√≠ntomas:**": "symptoms",
            "**causas probables:**": "causes",
            "**pasos de diagn√≥stico:**": "diagnosticSteps",
            "**soluciones recomendadas:**": "solution",
            "**alerta de seguridad:**": "alertaSeguridad",
            "**prevenci√≥n:**": "prevention"
        };
        
        let currentKey = "initial_desc";
        const tempItem = { initial_desc: [] };

        textResponse.split('\n').forEach(line => {
            const trimmedLine = line.trim();
            const lowerLine = trimmedLine.toLowerCase();
            let foundKey = false;

            for (const key in sections) {
                if (lowerLine.startsWith(key)) {
                    currentKey = sections[key];
                    foundKey = true;
                    const titleRest = trimmedLine.substring(key.length).trim();
                    if (titleRest) {
                         if (!tempItem[currentKey]) tempItem[currentKey] = [];
                         tempItem[currentKey].push(titleRest.replace(/^[-*‚Ä¢]\s*/, ''));
                    }
                    break;
                }
            }

            if (!foundKey && trimmedLine) {
                if (!tempItem[currentKey]) tempItem[currentKey] = [];
                tempItem[currentKey].push(trimmedLine.replace(/^[-*‚Ä¢]\s*/, ''));
            }
        });
        
        // Convertir saltos de l√≠nea en <br> para HTML
        const formatForHTML = (arr) => (arr || []).map(line => line.replace(/\n/g, '<br>'));
        
        // Si hay descripci√≥n inicial, usarla. Si no, usar la por defecto.
        item.initial = (tempItem.initial_desc.length > 0 ? formatForHTML(tempItem.initial_desc).join('<br>') : item.initial);
        
        item.symptoms = formatForHTML(tempItem.symptoms) || [];
        item.causes = formatForHTML(tempItem.causes) || [];
        item.diagnosticSteps = formatForHTML(tempItem.diagnosticSteps) || [];
        item.solution = formatForHTML(tempItem.solution) || [];
        item.prevention = formatForHTML(tempItem.prevention) || [];
        
        if (tempItem.alertaSeguridad && tempItem.alertaSeguridad.length > 0) {
            item.alertaSeguridad = formatForHTML(tempItem.alertaSeguridad).join('<br>');
        }
        
        // Fallback: si no parse√≥ secciones pero s√≠ hubo texto, ponerlo todo en la soluci√≥n.
        if (item.symptoms.length === 0 && item.causes.length === 0 && item.solution.length === 0 && tempItem.initial_desc.length > 0) {
            item.solution = formatForHTML(tempItem.initial_desc);
            item.initial = `Respuesta generada por IA para: "${query}" (formato no est√°ndar):`;
        }

    } catch (e) {
        console.error("Error parseando respuesta de IA, mostrando texto plano:", e);
        item.solution = [textResponse.replace(/\n/g, '<br>')];
    }
    
    // Si la respuesta es muy corta, probablemente sea un saludo o rechazo, poner en 'initial'
    if (textResponse.length < 100 && item.symptoms.length === 0 && item.solution.length === 0) {
        item.initial = textResponse;
    }

    return item;
}

async function handleExplainCodeClick(event) {
    const button = event.currentTarget;
    const codeToExplain = decodeURIComponent(button.dataset.code);
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Icono de carga

    const loadingItem = {
        _isGenerated: true, _sourceKey: "diagnostico", id: `gen_ai_code_${Date.now()}`,
        name: "Explicando C√≥digo...",
        initial: "Consultando a la IA para analizar el siguiente bloque de c√≥digo:",
        symptoms: [`<pre><code>${codeToExplain}</code></pre>`],
        alertaSeguridad: "Generando explicaci√≥n..."
    };
    showDiagnosis(loadingItem);

    try {
        const machineTypeKey = typeFilter.value || "maquinaria general";
        const machineName = machineTypes[machineTypeKey]?.name || machineTypeKey;

        const prompt = `Como experto en mantenimiento de maquinaria pesada, por favor explica el siguiente c√≥digo o script de diagn√≥stico en el contexto de un/una ${machineName}. Si ves un error obvio, ind√≠calo.

C√≥digo:
\`\`\`
${codeToExplain}
\`\`\`

Responde en espa√±ol y de forma clara. NO uses Markdown, solo texto plano y saltos de l√≠nea.`;

        const aiResponse = await askGeminiApi(prompt, machineName);
        
        const responseItem = {
            ...loadingItem,
            name: "Explicaci√≥n de C√≥digo (IA)",
            initial: `An√°lisis de IA para el c√≥digo en contexto de ${machineName}:`,
            symptoms: [`<strong>C√≥digo Analizado:</strong><pre><code>${codeToExplain}</code></pre>`],
            solution: [aiResponse.replace(/\n/g, '<br>')],
            alertaSeguridad: "Esta es una explicaci√≥n generada por IA. No ejecutes c√≥digo sin verificarlo."
        };
        
        showDiagnosis(responseItem);

    } catch (error) {
        const errorItem = {
            ...loadingItem,
            name: "Error de API",
            alertaSeguridad: `No se pudo contactar al asistente de IA: ${error.message}`
        };
        showDiagnosis(errorItem);
    }
}

// --- Funciones de Acciones (Popups, Exportar, etc.) ---
function copyDiagnosisToClipboard() {
    const item = currentDisplayedItem; if (!item) return alert('No hay diagn√≥stico seleccionado.'); const textSections = [ `DIAGN√ìSTICO: ${item.name || 'N/A'}`, `MODELOS: ${(item.modelosAplicables || []).join(', ') || 'N/A'}`, `S√çNTOMAS: ${(item.symptoms || ['N/A']).join('; ')}`, `CAUSAS: ${(item.causes || ['N/A']).join('; ')}`, `PASOS DIAGN√ìSTICO: ${(item.diagnosticSteps || ['N/A']).join(' | ')}`, `SOLUCI√ìN: ${(item.solution || ['N/A']).join('; ')}`, `ALERTA SEGURIDAD: ${item.alertaSeguridad || 'N/A'}`, `COSTO ESTIMADO: ${item.costoEstimado || 'Variable'}`, `C√ìDIGOS: ${(item.codes || ['N/A']).join(', ')}`, `DATO T√âCNICO: ${item.datoIngeniero || 'N/A'}`, `PREVENCI√ìN: ${(item.prevention || ['N/A']).join('; ')}`, `NOTAS ATACAMA: ${item.atacamaNotes || 'N/A'}` ]; const textToCopy = textSections.join('\n\n'); if (navigator.clipboard) { navigator.clipboard.writeText(textToCopy).then(() => alert('Diagn√≥stico copiado.')).catch(err => alert('Error al copiar: ' + err)); } else { alert('Copia manual requerida.'); console.log(textToCopy); }
}
function exportCurrentDiagnosis() {
    const item = currentDisplayedItem; if (!item) return alert('No hay diagn√≥stico.'); if (reviewBeforeExport.checked) { const proceed = confirm(`Exportar "${item.name}"?`); if (!proceed) return alert('Cancelado.'); } const payload = [item]; const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), count: 1, data: payload }, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `heavydiag_falla_${item.id || item.name.replace(/\s+/g, '_')}.json`; a.click(); URL.revokeObjectURL(url); alert(`Diagn√≥stico "${item.name}" exportado.`);
}
function printCurrentDiagnosis() {
    const item = currentDisplayedItem; if (!item) return alert('No hay diagn√≥stico.'); closeDiagnosisPanelBtn.style.display = 'none'; diagnosisPanel.querySelector('.action-buttons').style.display = 'none'; window.print(); closeDiagnosisPanelBtn.style.display = 'flex'; diagnosisPanel.querySelector('.action-buttons').style.display = 'flex';
}
function exportResults() {
    if (reviewBeforeExport.checked) { const count = currentResults.length; const proceed = confirm(`Exportar ${count} registros filtrados?`); if (!proceed) return alert('Cancelado.'); } const payload = currentResults.length ? currentResults : allItemsFlat; const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), count: payload.length, data: payload }, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `heavydiag_export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; a.click(); URL.revokeObjectURL(url); alert(`${payload.length} registros exportados.`);
}
function showKPIPopup() {
  const kpiWin = window.open('', '_blank', 'width=900,height=700'); const html = `<html><head><title>KPIs - HeavyDiag</title><style>body{font-family:Segoe UI,Arial;background:#111827;color:#e5e7eb;padding:20px;} h2,strong{color:#f5b74f;}</style></head><body><h2>KPIs y Predicci√≥n (Demo)</h2><ul><li><strong>Disponibilidad (MTBF):</strong> 1200 h</li><li><strong>MTTR promedio:</strong> 6.5 h</li><li><strong>OEE estimado:</strong> 78%</li><li><strong>Modelo predictivo:</strong> RandomForest/LSTM sugerido.</li></ul><p>Implementaci√≥n requiere hist√≥ricos y entrenamiento (Python/ML).</p></body></html>`; kpiWin.document.write(html); kpiWin.document.close();
}
function showTechPopup() {
  const techWin = window.open('', '_blank', 'width=900,height=700'); const html = `<html><head><title>T√©cnicas Avanzadas</title><style>body{font-family:Segoe UI,Arial;background:#111827;color:#e5e7eb;padding:20px;} h2,h3{color:#f5b74f;}</style></head><body><h2>T√©cnicas Diagn√≥stico Avanzado</h2><h3>Vibraciones</h3><p>Aceler√≥metros triaxiales, >=10kHz, FFT, ISO10816-3.</p><h3>Termograf√≠a</h3><p>Detectar hotspots (>15¬∞C Delta T).</p><h3>An√°lisis Aceite</h3><p>ICP/OES (ppm), Ferrograf√≠a, ISO 4406.</p><h3>Ultrasonido</h3><p>Pulso-eco para fisuras.</p><h3>Alineaci√≥n L√°ser</h3><p>Precisi√≥n <0.05 mm/m, compensar T¬∞.</p><h3>CFD / FEA</h3><p>Simulaciones para bombas y estructuras.</p></body></html>`; techWin.document.write(html); techWin.document.close();
}

</script>
</body>
</html>
